55 |
62 |
80 |
81 |     Ensures all required parameters are populated from TradingConfig with
80 |
81 |     Ensures all required parameters are populated from TradingConfig with
81 |     Ensures all required parameters are populated from TradingConfig with
83 |
86 |
93 |
103 |
107 |
113 |     runtime.data_client = getattr(lazy_context, 'data_client', None)
30 |
35 |
50 |
55 |
69 |
73 |
79 |
81 |
84 |
87 |
91 |
96 |
103 |
105 |
107 |
111 |
115 |
126 |
129 |
131 |
134 |
147 |
158 |
161 |
171 |
174 |
178 |
181 |
190 |
195 |
200 |
203 |
205 |
208 |
211 |
213 |
222 |
224 |             symbol: Trading symbol
224 |             symbol: Trading symbol
227 |
233 |
237 |
239 |
245 |             # Adjusting forwards - include actions after reference_date up to target_date
245 |             # Adjusting forwards - include actions after reference_date up to target_date
247 |
250 |
254 |
259 |
282 |
287 |
293 |
295 |
302 |
305 |
309 |
316 |
323 |
328 |
333 |
338 |
345 |
349 |
360 |
370 |
373 |         symbol="AAPL",
380 |
384 |         ex_date="2021-07-20",
23 |
28 |
41 |
44 |
47 |
51 |
54 |
56 |
58 |
75 |
78 |
87 |
100 |
104 |
108 |
123 |
127 |
131 |
134 |
137 |
140 |
143 |
147 |
153 |
158 |
183 |
191 |
194 |
199 |
201 |
210 |
214 |
221 |
224 |
226 |
24 |
28 |
32 |
36 |
42 |
50 |
54 |
58 |
64 |
75 |
83 |
87 |
93 |
96 |
 99 |
103 |
109 |
112 |             rejection_mask |= outlier_mask
112 |             rejection_mask |= outlier_mask
114 |
119 |
124 |
128 |
132 |
143 |
145 |
150 |
153 |
157 |
159 |
165 |
171 |
180 |
182 |
187 |
189 |
193 |
197 |
201 |
205 |
210 |
215 |
220 |
222 |
227 |
229 |
233 |
237 |
244 |
249 |
254 |
256 |
261 |
266 |
271 |
275 |
279 |
284 |
286 |
291 |
296 |
298 |
303 |
308 |
310 |
314 |
321 |
323 |
333 |
338 |
344 |
348 |
352 |
359 |
361 |
366 |
371 |
379 |
383 |
389 |
392 |
396 |
398 |
402 |
410 |
412 |
438 |
443 |
458 |
463 |
469 |
472 |
475 |
479 |
479 |
23 |
27 |
37 |
48 |
58 |
64 |
84 |
92 |
96 |
 99 |
105 |
108 |
112 |
117 |
123 |
131 |
138 |
142 |
152 |
155 |             test_indices: Test indices
158 |
165 |
169 |
177 |
184 |
197 |
199 |
203 |
223 |
228 |         test_span: Test period length (days or timedelta)
228 |         test_span: Test period length (days or timedelta)
230 |
238 |
244 |
247 |
251 |
254 |
261 |
265 |
269 |
273 |
286 |
290 |
293 |
296 |
310 |
316 |
326 |
332 |
335 |
344 |
347 |
100 |
112 |
146 |
151 |
199 |
204 |
233 |
238 |
297 |
303 |
336 |
342 |
380 |
389 |
468 |
476 |
599 |
602 |
117 |
250 |
257 |
269 |
275 |
275 |
281 |
286 |
294 |
299 |
304 |
309 |
502 | # Create emit-once logger instance for preventing duplicate startup messages
137 |
141 |
148 |
150 |
155 |
155 |
160 |
164 |
169 |
170 |     def record_trade_metrics(self, symbol: str, side: str, quantity: float, price: float,
169 |
170 |     def record_trade_metrics(self, symbol: str, side: str, quantity: float, price: float,
174 |
182 |
184 |
193 |
206 |
213 |
217 |
225 |
227 |
231 |
231 |
235 |
239 |
244 |
248 |
258 |
262 |
266 |
270 |
281 |
281 |
284 |
292 |
76 |
87 |
116 |
121 |
199 |
204 |
248 |
254 |
319 |
325 |
375 |
380 |
521 |
524 |
21 | | # Use hard imports since numpy and pandas are dependencies
21 | # Use hard imports since numpy and pandas are dependencies
33 |     "pd",
39 |     "PANDAS_AVAILABLE",
77 |
82 |
92 |
97 |
97 |
102 |
108 |
189 |
193 |
210 |                     logger.warning("Trade result missing required field %s for strategy %s",
213 |
220 |
222 |
223 |             logger.debug("Recorded trade for strategy %s: PnL=%.2f, Return=%.4f",
222 |
223 |             logger.debug("Recorded trade for strategy %s: PnL=%.2f, Return=%.4f",
223 |             logger.debug("Recorded trade for strategy %s: PnL=%.2f, Return=%.4f",
225 |
232 |
233 |     def calculate_strategy_allocations(self, strategies: List[str],
232 |
233 |     def calculate_strategy_allocations(self, strategies: List[str],
232 |
233 |     def calculate_strategy_allocations(self, strategies: List[str],
237 |
241 |
249 |
255 |
257 |
260 |
263 |
266 |                 strategy: weight * total_capital
269 |
273 |
275 |             logger.info("Strategy allocations updated: %s",
275 |             logger.info("Strategy allocations updated: %s",
275 |             logger.info("Strategy allocations updated: %s",
277 |
279 |
283 |
287 |
292 |
295 |                 logger.debug("Insufficient trades for strategy %s (%d < %d) - using default score",
298 |
302 |
305 |
308 |
314 |
318 |
321 |
325 |
331 |
337 |
338 |             composite_score = (sharpe_component + return_component +
337 |
338 |             composite_score = (sharpe_component + return_component +
337 |
338 |             composite_score = (sharpe_component + return_component +
338 |             composite_score = (sharpe_component + return_component +
340 |
343 |
345 |                         strategy_name, sharpe_ratio, avg_return * 252, hit_rate * 100,
343 |
345 |                         strategy_name, sharpe_ratio, avg_return * 252, hit_rate * 100,
345 |                         strategy_name, sharpe_ratio, avg_return * 252, hit_rate * 100,
345 |                         strategy_name, sharpe_ratio, avg_return * 252, hit_rate * 100,
347 |
349 |
356 |
362 |
367 |
370 |
373 |
378 |
380 |
385 |
387 |
392 |
398 |
402 |
409 |
419 |
425 |
427 |
432 |
438 |
448 |
452 |
456 |
464 |
466 |
473 |
479 |
482 |
486 |
490 |
494 |
496 |             rank_changes = sum(1 for i, (old_s, _) in enumerate(old_ranking)
496 |             rank_changes = sum(1 for i, (old_s, _) in enumerate(old_ranking)
496 |             rank_changes = sum(1 for i, (old_s, _) in enumerate(old_ranking)
498 |
500 |
502 |
45 |         pass
13 |
16 |
19 |
26 |
30 |
33 |
33 |
37 |
43 |
47 |
54 |
59 |
65 |
72 |
74 |
81 |
85 |
88 |
102 |
109 |
113 |
117 |
122 |
122 |
125 |
136 |
140 |
153 |
160 |
160 |
168 |
168 |
174 |
179 |
187 |
191 |
193 |
197 |
202 |
202 |
206 |
211 |
211 |
220 |
229 |
232 |
236 |
240 |
246 |
250 |
253 |
257 |
262 |
275 |
277 |
281 |
281 |
283 |
286 |
291 |
297 |
303 |
303 |
308 |
36 |
108 |
113 |
116 |
159 |
163 |
219 |
267 |
272 |
12 |     python debug_cli.py positions                 # Check position discrepancies
35 |
38 |
45 |
50 |
58 |
67 |
70 |
72 |
83 |
94 |
104 |
107 |
116 |
121 |
121 |
123 |
132 |
136 |
149 |
161 |
164 | |             get_pnl_attributor, get_symbol_pnl_breakdown,
167 |
164 |             get_pnl_attributor, get_symbol_pnl_breakdown,
167 |
169 |
173 |
183 |
189 |
189 |
201 |
206 |
213 |
219 |
228 |
231 |
234 |
241 |
248 |
250 |
259 |
263 |
269 |
272 |
281 |
286 |
286 |
288 |
292 |
295 |
298 |
302 |
306 |
306 |
310 |
313 |
322 |
329 |
340 |
342 |
345 |
349 |
352 |
356 |
360 |
363 |
365 |
369 |
386 |
7 | This script shows how the ai_trading.imports module provides graceful
24 |
30 |
43 |
50 |
50 |
60 |
68 |
74 |
74 |
79 |
86 |
92 |
92 |
98 |
100 |
105 |
105 |
109 |
113 |
118 |
123 |
127 |
136 |
142 |
22 |
25 |
28 |     balanced_config = config.TradingConfig.from_env("balanced")
28 |     balanced_config = config.TradingConfig.from_env("balanced")
30 |
37 |
46 |
49 |
64 |
67 |
72 |
78 |
81 |
81 |
83 |
83 |
91 |
91 |
 99 |
 99 |
17 |
20 |
28 |
34 |
36 |
49 |
56 |
56 |
59 |
64 |
69 |
78 |
87 |
91 |
97 |
97 |
48 |
48 |
50 |
50 |
52 |
61 |
64 |
73 |
73 |
83 |
85 |
87 |
90 |
97 |
98 |     # Demo volume analysis
 97 |
 98 |     # Demo volume analysis
103 |
109 |
115 |
125 |
127 |
129 |
132 |
138 |
143 |
148 |
153 |
163 |
165 |
167 |
170 |
179 |
184 |
189 |
194 |
204 |
206 |
208 |
211 |
219 |
227 |
233 |
238 |
248 |
250 |
252 |
255 |
260 |
268 |
278 |
281 |
288 |
298 |
308 |
318 |
333 |
342 |
348 |
32 |
38 |
43 |
50 |
50 |
57 |
57 |
64 |
64 |
75 | …
75 |
85 |
96 |
96 |
106 |
117 |
127 |
132 |
137 |
141 |
148 |
159 |
165 | …
173 |
183 |
191 |
195 |
197 |
202 |
35 |
74 |
79 |
102 |
108 |
139 |
32 |
52 |
577 |
581 |
590 |
596 |
602 |
608 |
614 |
621 |
631 |
640 |
656 |
662 |
668 |
674 |
679 |
684 |                 tradesDiv.innerHTML = recentTrades.map(trade =>
691 |
698 |
706 |
706 |
710 |
714 |                 alertsSection.innerHTML = '<h3>Recent Alerts</h3>' +
721 |
724 |
19 |
23 |
27 |
32 |
38 |
41 |
48 |
57 |
64 |
67 |
75 |
80 |
84 |
89 |
94 |
97 |
109 |
113 |
121 |
131 |
135 |
135 |
138 |
143 |
146 |
158 |
174 |
177 |
180 |
183 |
187 |
190 |
193 |
197 |
206 |
214 |
28 |
31 |
34 |
34 |
41 |
50 |
57 |
60 |
63 |
69 |
74 |
79 |
79 |
85 |
92 |
95 |
97 |
101 |
108 |
114 |
122 |
131 |
138 |
141 |
143 |
147 |
151 |
155 |
163 |
166 |         failed_services = [name for name, info in service_status.items()
166 |         failed_services = [name for name, info in service_status.items()
168 |
175 |
182 |
188 |
195 |
200 |
207 |
214 |
224 |
230 |
239 |
242 |     demo_memory_optimizer()
247 |
249 |
252 |         "Memory optimizer with aggressive GC and leak detection",
262 |
266 |
272 |
22 |
32 |
37 |
45 |
47 |
59 |
66 |
68 |
72 |
73 |             # CPU metrics
72 |
73 |             # CPU metrics
73 |             # CPU metrics
75 |
78 |
81 |
84 |
87 |
91 |
93 |
95 |
 99 |
107 |
113 |
117 |
130 |
133 |
135 |
139 |
147 |
150 |
153 |
153 |
156 |
158 |
162 |
165 |
168 |
175 |
181 |
193 |
195 |
198 |
200 |
204 |
208 |
220 |
225 |
229 |
236 |
239 |
241 |
245 |
250 |
254 |                 ['ps', 'aux'],
255 |                 capture_output=True,
256 |                 text=True,
254 |                 ['ps', 'aux'],
255 |                 capture_output=True,
256 |                 text=True,
254 |                 ['ps', 'aux'],
255 |                 capture_output=True,
256 |                 text=True,
260 |
264 |
266 |
270 |
274 |
277 |
281 |
284 |
291 |
296 |
302 |
304 |
323 |
328 |
328 |
335 |
338 |
342 |             result = subprocess.run(['pgrep', '-f', 'python'],
348 |
352 |
361 |
366 |
368 |
372 |
375 |
380 |
382 |             trading_modules = [name for name in sys.modules.keys()
382 |             trading_modules = [name for name in sys.modules.keys()
383 |                              if any(keyword in name.lower() for keyword in
382 |             trading_modules = [name for name in sys.modules.keys()
383 |                              if any(keyword in name.lower() for keyword in
386 |
389 |
391 |
395 |
399 |
399 |
408 |
408 |
417 |
421 |
421 |
430 |
434 |
434 |
443 |
443 |
452 |
463 |
467 |
469 |
477 |
480 |
485 |
492 |
496 |
499 |
503 |
507 |
510 |
513 |
516 |
519 |
531 |
538 |
542 |
547 |
550 |
556 |
560 |
560 |
573 |
579 |
584 |
592 |
600 |
615 |
620 |
625 |
653 |
656 |
660 |
664 |
670 |
6 | - Memory usage optimization and leak detection
21 |     "PortfolioOptimizer",
19 |
23 |
28 |
36 |
38 |
42 |
50 |
53 |
72 | …
76 |
81 |
84 |
95 |
 98 |
103 |
106 |
109 |
119 |
121 |
126 |
133 |
135 |
141 |
149 |
155 |
159 |
166 |
170 |
174 |
184 |
189 |
197 |
199 |
203 |
206 |
212 |
212 |
216 |
219 |
223 |
226 |
229 |
233 |
239 |
251 |
260 |
263 |
273 |
278 |             'ai-trading-scheduler.service',
282 |
284 |
292 |
299 |
308 |
315 |
317 |
325 |
333 |
340 |
352 |
359 |
365 |
367 |
373 |
377 |
392 |
394 |
395 |     def _generate_recommendations(self, processes: List[Dict], duplicates: List[Dict],
394 |
395 |     def _generate_recommendations(self, processes: List[Dict], duplicates: List[Dict],
399 |
407 |
414 |
416 |         failed_services = [name for name, info in service_status.items()
416 |         failed_services = [name for name, info in service_status.items()
423 |
431 |
438 |
443 |
451 |
457 |
475 |
479 |
490 |
494 |
502 |
510 |
517 |
534 |
542 |
544 |
547 |
552 |
557 |
557 |
565 |
570 |
574 |
578 |
582 |
584 |
592 |
592 |
597 |
597 |
31 |
35 |
39 |
44 |
55 |
57 |
61 |
63 |
72 |
75 |
83 |
88 |
91 |
94 |
 99 |
103 |
107 |
111 |
116 |
116 | …
123 |
125 |
135 |
139 |
141 |
149 |
152 |
160 |
163 |
168 |             "test_span": 63,    # 3 months testing
174 |
176 |
183 |
185 |
197 |
199 |
203 |
212 |
218 |                 'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA',
221 |
225 |
227 |
234 |
237 |
244 |
251 |
254 |
257 |
257 |
262 |
38 |
51 |
58 |
65 |         "ai_trading.monitoring", "PerformanceMonitor",
68 |
80 |
83 |         "ai_trading.config.management", "TradingConfig",
86 |
91 |
96 |
101 |             'scheduler_iterations', 'scheduler_sleep_seconds', 'window',
104 |
109 |
114 |
114 |
121 |
121 |
124 |
135 |
139 |
142 |
149 |
152 |
6 | 1. LazyBotContext has .params attribute
24 |
28 |
32 |
34 |
44 |
47 |
51 |
54 |
56 |
66 |
67 |         # Create mock runtime with params attribute
66 |
67 |         # Create mock runtime with params attribute
66 |
67 |         # Create mock runtime with params attribute
74 |
78 |
88 |
91 |
106 |
108 |
119 |
119 |
122 |
125 |
130 |
132 |
134 |
144 |
151 |
164 |
166 |
6 | - Meta-learning system status
53 |
22 |     "LiquidityTier",
11 | 2. MetaLearning Strategy Method Signature Mismatch (CRITICAL)
21 |
26 |
31 |
36 |
47 |
50 |
50 |
53 |
55 |
63 |
65 |
71 |
76 |
83 |
85 |
93 |
100 |
103 |
103 |
106 |
108 |
116 |
120 |
120 |
128 |
131 |
138 | …
139 | …     # Mean reversion - mixed performance
138 | …
139 | …     # Mean reversion - mixed performance
143 | …
149 | …
153 |
157 |
159 |
163 |
163 |
167 |
171 |
171 |
173 |
173 |
177 |
179 |
189 |
198 |
202 |
206 |
208 |
218 |
225 |
234 |
238 |
245 |
247 |
256 |
18 |
24 |
30 |
36 |
43 |
48 |
55 |
63 |
66 |
77 |
81 |
85 |
88 |
96 |
96 |
 99 |
105 |
112 |
119 |
125 |
128 |
131 |
143 |
151 |
154 |
164 |
166 |
32 |
47 |
51 |         "ai_trading/execution/transaction_costs.py",
56 |
66 |
70 |
81 |
85 |
88 |
93 |
 99 |
103 |
109 |
114 |
120 |
128 |
139 |
144 |
150 |     print("• Transaction costs moved to ai_trading.execution.transaction_costs")
154 |
24 |
27 |
31 |
34 |
37 | …
40 | …
44 |
47 |
52 | …
54 |
63 |
67 |
71 |
80 |
89 |
93 |
101 |
110 |
114 |
123 |
129 |
131 |
140 |
144 |
152 |
158 |
160 |
171 |
173 |
180 |
185 |
192 |
200 |
17 |
23 |
26 |
29 |
33 |
37 |
39 |
44 |
53 |
60 |
63 |
65 |
70 |
72 |
80 |
84 |
94 |
96 |
105 |
110 |
113 |
117 |
121 |
123 |
126 |
128 |
137 |
143 |
145 |
152 |
157 |
161 |
163 |
171 |
173 |
182 |
186 |
198 |
200 |
212 |
220 |
223 |
232 |
235 |
19 |
24 |
24 |
29 |
31 |
34 |
40 |
47 |
51 |
51 |
56 |
59 |
62 |
69 |
73 |         "ai_trading/market/__init__.py",
85 |
91 |
95 |
102 |
108 |
118 |
121 |
123 |
11 | 2. Load .env before constructing settings, lazy-import the engine
27 |
31 |
53 |
55 |
60 |
66 |
71 |
77 |
81 |
87 |
94 |
100 |
104 |
113 |
117 |
121 |
124 |
134 |
138 |
142 |
142 |
149 |
157 |
164 |
171 |
173 |
178 |
183 |
192 |
195 |
199 |
203 |
203 |
210 |
220 |
229 |
240 |
244 |
247 |
256 |
260 |
263 |
23 |
26 |
30 |
35 |
39 |
46 |
49 |
52 | …         return False, f"⚠️  Placeholder values detected in .env: {', '.join(placeholder_vars)}\n   Please replace YOUR_* placeholder…
53 | …
55 |
68 |
72 |
74 |
82 |
90 |
96 |
 99 |
103 |
105 |
117 |
121 |
121 |
126 |
154 |
156 |
162 |
168 |
174 |
176 |
186 |
67 |
74 |
79 |
84 |
90 |
94 |
 98 |
106 |
127 |
147 |
159 |
163 |
167 |
174 |
178 |
183 |
186 |
189 |
192 |
195 |
209 |
217 |
229 |
234 |
238 |
241 |
253 |
257 |
261 |
264 |
267 |
270 |
276 |
279 |
282 |
287 |
296 |
306 |
309 |
312 |
317 |
348 |
353 |
359 |
362 |
365 |
368 |
371 |
374 |
408 |
413 |
416 |
419 |
424 |
429 |
432 |
435 |
450 |
464 |
467 |
474 |
474 |
501 |
520 |
523 |
542 |
545 |
561 |
564 |
565 |         @property
564 |
565 |         @property
575 |
587 |                     @property
592 |
593 |         @index.setter
592 |
593 |         @index.setter
596 |
600 |
612 |
615 |
620 |
624 |
628 |
635 |
644 |
648 |
655 |
667 | …                         # Mock rolling mean - for our test case, make it around 1.5
672 |
686 |
688 |
691 |
703 |
715 |
715 |
718 |
732 |
751 |
754 |
757 |
762 |
769 |
774 |
781 |
785 |
789 |
792 |
795 |
812 |
818 |
828 |
831 |
834 |
852 |
859 |
899 |
905 |
915 |
973 |
977 |
982 |
987 |
991 |
995 |
 999 |
1007 |
1016 |
1021 |
1025 |
1031 |
1035 |
1048 |
1051 |
1055 |
1058 |
1075 |
1079 |
1082 |
1085 |
1086 |     # Data module
1085 |
1086 |     # Data module
1092 |
1096 |
1100 |
1104 |
1110 |
1126 |
1134 |
1140 |
1144 |
1147 |
1154 |
1159 |
1178 |
1181 |
1200 |
1204 |
1208 |
1214 |
1232 |
1238 |
1277 |
1281 |
1284 |
1287 |
1290 |
1301 |
1305 |
1310 |
1313 |
1316 |
1329 |
1334 |
1337 |
1349 |
1353 |
1356 |
1359 |
1362 |
1373 |
1381 |
1389 |
1403 |
1406 |
1467 |
1476 |                 # If config is an instance, set it as an attribute
1479 |         # AI-AGENT-REF: Log config import failure for debugging
1484 |
1498 |
1513 |
1514 |
1513 |
1514 |
16 |     "TradingScenarioRunner",
16 |     "TradingScenarioRunner",
49 |
53 |
59 |
64 |
72 |
82 |
85 |
92 |
98 |
 98 |
106 |
110 |
113 |
117 |
124 |
132 |
135 |
141 |
144 |
151 |
154 |
156 |
160 |
167 |
176 |
180 |
184 |
189 |
192 |
195 |
202 |
205 |
220 |
225 |
235 |
240 |
244 |
253 |
258 |
264 |
268 |
275 |
280 |
284 |
288 |
290 |
297 |
302 |
314 |
321 |
326 |
330 |
334 |
341 |
350 |
357 |
364 |
371 |
383 |
387 |
391 |
395 |
402 |
410 |
413 |
419 |
422 |
429 |
432 |
434 |
441 |
448 |
455 |
462 |
33 |
40 |
49 |
54 |
59 |
64 |
67 |
71 |
74 |
79 |
82 |
82 |
87 |
89 |
94 |
94 |
 99 |
102 |
102 |
107 |
114 |
118 |
123 |
127 |
132 |
134 |
137 |
139 |
145 |
150 |
155 |
160 |
166 |
170 |
174 |
182 |
187 |
191 |
191 |
196 |
196 |
202 |
206 |
210 |
214 |
219 |
224 |
229 |
233 |
238 |
240 |
243 |
245 |
248 |
248 |
254 |
264 |
268 |
283 |
289 |
293 |
298 |
298 |
301 |
311 |
315 |
325 |
12 |
18 |
22 |
31 |
36 |
38 |
42 |
 8 |
18 |
31 |
35 |
52 |
56 |
18 |
21 |
24 |
28 |
32 |
34 |
45 |
50 |
54 |
59 |
61 |
72 |
77 |
79 |
83 |
87 |
89 |
100 |
105 |
113 |
116 |
119 |
124 |
127 |
129 |
142 |
142 |
142 |
146 |
150 |
156 |
164 |
167 |
171 |
176 |
178 |
189 |
192 |
201 |
206 |
210 |
214 |
218 |
220 |
231 |
231 |
231 |
235 |
243 |
250 |
253 |
262 |
273 |
281 |
16 |
20 |
22 |
27 |
40 |
44 |
46 |
50 |
34 | @pytest.mark.smoke
39 |
47 |
57 |
63 |
67 |         "qty", "side", "strategy", "classification", "signal_tags",
71 |
75 |
81 |
82 |     # Validate no UUID-like strings in symbol column
81 |
82 |     # Validate no UUID-like strings in symbol column
81 |
82 |     # Validate no UUID-like strings in symbol column
92 |
 99 |
109 |
114 |
121 |
28 |
28 |
32 |
37 |
209 |
213 |
18 |
23 |
33 |
35 |
43 |
51 |
62 |
64 |
73 |
105 |
113 |
116 |
121 |
127 |
19 |
23 |
30 |
34 |
39 |
45 |
50 |
55 |
59 |
67 |
71 |
79 |
83 |
91 |
96 |
106 |
111 |
117 |
122 |
127 |
132 |
137 |
141 |
150 |
157 |
163 |
170 |
175 |
182 |
186 |
194 |
196 |
201 |
207 |
210 |
214 |
221 |
226 |
229 |
232 |
235 |
238 |
241 |
12 | |         setup_logging,
13 | |         get_logger,
12 |         setup_logging,
13 |         get_logger,
12 |         setup_logging,
13 |         get_logger,
12 |         setup_logging,
13 |         get_logger,
13 |         get_logger,
27 |
32 |
37 |             'ALPACA_SECRET_KEY': 'test',
45 |
49 |
53 |
57 |
63 |
67 |
67 |
75 |
82 |
95 |
100 |
103 |
115 |
122 |
129 |
133 |
136 |
139 |
142 |
15 |
21 |
29 |
34 |
49 |
52 |
55 |
63 |
73 |
80 |
88 |
 99 |
102 |
105 |
119 |
122 |
126 |
134 |
141 |
150 |
152 |
158 |
161 |
161 |
18 |
17 |
23 |
27 |
30 |             'OrderSide', 'OrderType', 'OrderStatus', 'RiskLevel',
33 |
36 |
44 |
44 |
48 |         assert OrderStatus.PENDING.value == "pending"
52 |
56 |
60 |
65 |
69 |
73 |             "RISK_PARAMETERS",
80 |
84 |
88 |
90 |             "OrderSide", "OrderType", "OrderStatus", "RiskLevel",
90 |             "OrderSide", "OrderType", "OrderStatus", "RiskLevel",
93 |
19 |
22 |
27 |
33 |
39 |
50 |
53 |
76 |
94 |
94 |
94 |
97 |
106 |
115 |
115 |
121 |
127 |
133 |
135 |
140 |
140 |
150 |
152 |
156 |         'High': [101, 102, 103],
161 |
164 |
167 |
167 |
175 |
177 |
181 |
186 |
206 |
209 |
218 |
222 |
222 |
232 |
234 |
238 |     max_exp = risk_engine.max_exposure()
238 |     max_exp = risk_engine.max_exposure()
240 |
245 |
51 |
60 |
66 |                 self.assertTrue(0 <= signal.confidence <= 1,
88 |
90 |
94 |
96 |         self.assertTrue(hasattr(engine, '_reconcile_partial_fills'),
96 |         self.assertTrue(hasattr(engine, '_reconcile_partial_fills'),
104 |
107 |
109 |         self.assertTrue(hasattr(engine, '_validate_short_selling'),
109 |         self.assertTrue(hasattr(engine, '_validate_short_selling'),
117 |
121 |
128 |
132 |
141 |
149 |
154 |
158 |
163 |
181 |
192 |
196 |
200 |
203 |
206 |
208 |
213 |
220 |
225 |
228 |
238 |
240 |
247 |
251 |
258 |
260 |
267 |
274 |
278 |
282 |
285 |
33 |
33 |
38 |
43 |
48 |
52 |         'low': [1e-8, 1e-8, 1e-8],
63 |
65 |
69 |
78 |
85 |
88 |
 98 |
101 |
107 |
120 |
123 |
132 |
135 |
139 |
156 |
156 |
159 |
165 |
170 |
175 |
178 |
182 |
185 |
194 |
196 |
205 |
209 |
218 |
228 |
236 |
238 |
255 |
255 |
257 |
261 |
266 |
278 |
280 |
284 |
287 |
291 |
296 |
305 |
308 |
311 |
314 |
317 |
320 |
323 |
326 |
329 |
332 |
335 |
335 |
12 |
15 |
17 |
26 |
31 |
35 |
40 |
48 |
56 |
63 |
68 |
73 |
75 |
85 |
90 |
100 |
102 |
110 |
114 |
121 |
123 |
130 |
139 |
143 |
146 |
157 |
164 |
53 |                 self.assertIn('SENTIMENT_FAILURE_THRESHOLD = 8', content,
55 |                 self.assertIn('SENTIMENT_RECOVERY_TIMEOUT = 900', content,
53 |                 self.assertIn('SENTIMENT_FAILURE_THRESHOLD = 8', content,
55 |                 self.assertIn('SENTIMENT_RECOVERY_TIMEOUT = 900', content,
100 |
104 |
110 |
114 |
119 |
124 |
129 |
31 |
35 |
53 |
58 |
61 |
64 |
71 |
74 |         time_since_trade = now - trade_cooldowns[symbol]
77 |
83 |
86 |
95 |
110 |
114 |
118 |
118 |
125 |
129 |
133 |
141 |
146 |
154 |
161 |
164 |
164 |
170 |
178 |
181 |
185 |
190 |
194 |
199 |
7 | 2. Aggressive Liquidity Management
60 |
65 |
74 |
82 |
85 |
88 |
91 |
103 |
108 |
110 |
113 |
118 |
121 |
125 |
130 |
133 |
141 |
145 |
151 |
156 |
160 |
170 |
174 |
176 |
182 |
185 |
190 |
202 |
210 |
212 |
217 |
219 |
223 |
227 |
227 |
231 |
243 |
247 |
247 |
251 |
257 |
263 |
273 |
277 |
285 |
290 |
293 |
298 |
305 |
313 |
317 |
323 |
328 |
339 |
343 |
346 |
349 |
356 |
365 |
373 |
378 |
384 |
387 |
392 |             'SENTIMENT_FALLBACK_SOURCES',
398 |
405 |
413 |
425 |
429 |
439 |
442 |
446 |
449 |
452 |
466 |
478 |
483 |
503 |
507 |
510 |
510 |
521 | |
521 |
527 |
533 |
538 |
548 |
553 |
554 |     # Test Case 2: Actual full fill scenario
553 |
554 |     # Test Case 2: Actual full fill scenario
557 |
561 |
567 |         side="buy",
570 |
575 |
579 |
581 |     mock_order_mismatch.id = "order_789"
581 |     mock_order_mismatch.id = "order_789"
581 |     mock_order_mismatch.id = "order_789"
583 |
593 |
598 |
608 |
612 |
617 |
626 |
626 |
626 |
637 |
642 |
653 |
660 |
670 |
681 |
686 |
701 |
707 |
710 |
714 |
720 |
727 |
739 |
744 |
754 |
754 |
42 |
48 |
55 |
64 |
68 |
74 |
80 |
84 |
84 |
89 |
93 |
97 |
104 |
106 |
112 |
117 |
123 |
128 |
134 |
137 |
140 |
141 |                 # The issue: function returns the order but doesn't validate
140 |
141 |                 # The issue: function returns the order but doesn't validate
150 |
155 |
163 |
168 | …         # Meta format row (Symbol in first column)
168 | …     # Meta format row (Symbol in first column)
173 |
178 |
181 |
186 |
193 |
200 |
205 |
209 |
215 |
222 |
227 |
230 |
233 |
242 |
249 |
252 |
254 |
260 |
263 |
263 |
267 |
271 |
276 |
282 |
288 |
291 |
294 |
294 |
298 |
303 |
307 |
313 |
316 |
322 |
328 |
343 |
17 |
17 |
20 |
31 |
38 |
41 |
49 |
55 |
62 |
64 |
70 |
32 |
36 |
41 |
45 |
51 |
58 |
62 |
65 |
69 |
73 |
77 |
80 |
85 |
89 |
92 |
97 |
114 |
116 |
120 |
127 |
132 |
134 |
140 |
152 |
152 |
16 |
21 |             "ALPACA_SECRET_KEY": "fake_alpaca_secret_not_real",
24 |
27 |
31 |
39 |
42 |
46 |
57 |
60 |
65 |
72 |
75 |
79 |
86 |
89 |
90 |             assert api_key == "fake_apca_key_mixed_not_real"
89 |
90 |             assert api_key == "fake_apca_key_mixed_not_real"
93 |
101 |
104 |
108 |
113 |
117 |
123 |
126 |
130 |
136 |
139 |
143 |
153 |
156 |
163 |
173 |
176 |
179 |
186 |
194 |
198 |
207 |
211 |
214 |
223 |
227 |
230 |
239 |
243 |
245 |
254 |
258 |
33 |
37 |
40 |
52 |
59 |
62 |
66 |
80 |
82 |
92 |
94 |
103 |
116 |
118 |
130 |
132 |
147 |
149 |
19 |
24 |
32 |
37 |
42 |
54 |
59 |
65 |
76 |
82 |
88 |
93 |     emit_once.warning("Warning message")
93 |     emit_once.warning("Warning message")
95 |
104 |
108 |
110 |
116 |
123 |
32 |
37 |
41 |
46 |
51 |
54 |
58 |
64 |
73 |
80 |
83 |             "test_id_123",
87 |
93 |
 99 |
103 |
106 |             "test_id_123",
110 |
114 |
118 |
124 |
129 |
133 |
140 |
147 |
153 |
158 |
166 |
174 |
183 |
188 |
190 |
199 |
204 |
208 |
212 |
215 |
218 |
221 |
224 |
228 |
231 |
234 |
238 |
240 |
243 |
250 |
254 |
258 |
262 |
266 |
270 |
274 |
278 |
282 |
286 |
290 |
299 |
303 |
311 |
316 |
318 |
323 |
334 |
337 |
340 |
344 |
348 |
352 |
356 |
364 |
372 |
376 |
379 |
383 |
388 |
391 |
397 |
403 |
407 |
411 |
414 |
419 |
423 |
430 |
433 |
440 |
445 |
450 |
453 |
459 |
467 |
470 |
470 |
474 |
474 |
478 |
483 |
487 |
492 |
496 |
498 |
502 |
506 |
510 |
515 |
520 |
530 |
534 |         TestPositionReconciliation,
538 |
542 |
546 |
552 |
552 |
557 |
20 |
25 |
29 |
32 |
36 |
47 |
49 |
53 |
56 |
59 |
59 |
70 |
73 |
75 |
79 |
79 |
91 |
16 |
24 |
31 |
41 |
43 |
45 |
50 |
56 |
66 |
71 |
77 |
80 |
84 |
89 |
93 |
101 |
104 |
108 |
112 |
116 |
121 |
124 |
127 |
131 |
135 |
139 |
143 |
149 |
152 |
155 |
158 |
161 |
169 |
172 |
175 |
178 |
181 |
188 |
192 |
200 |
207 |
210 |
214 |
220 |
227 |
231 |
235 |
235 |
239 |
241 |
250 |
256 |
262 |
266 |
15 |
21 |             symbol="AAPL",
27 |
38 |
47 |
52 |
63 |
68 |
81 |
83 |
97 |
101 |
107 |
116 |
126 |
134 |
144 |
148 |
157 |
160 |
169 |
172 |
182 |
185 |
194 |
197 |
207 |
209 |
221 |
223 |
235 |
244 |
246 |
253 |
262 |
264 |
271 |
275 |
282 |
291 |
303 |
305 |
316 |
321 |
331 |
334 |
342 |
13 |
17 |
19 |
23 |
31 |
41 |
48 |
51 |
63 |
71 |
75 |
81 |
81 |
92 |
95 |
101 |
115 |
118 |
121 |
121 |
128 |
45 |
47 |
53 |
55 |
60 |
65 |
68 |     first_call = call_times[0][1]
71 |
80 |
86 |
89 |
93 |
97 |
100 |
102 |
105 |
105 |
56 |     assert (na_counts <= 20).all(), f"Excessive NaNs in features: {na_counts}"
10 |     'ALPACA_SECRET_KEY': 'test_secret',
25 |
28 |
30 |
33 |
38 |             side="buy",
41 |
44 |
46 |
48 |
54 | @pytest.mark.smoke
57 |
60 |
62 |
65 |
73 |
76 |
78 |
82 |
85 |             submitted_qty=50,
90 |
93 |
93 |
95 |
97 |         mock_logger.reset_mock()
97 |         mock_logger.reset_mock()
 97 |         mock_logger.reset_mock()
 99 |
104 |             side="buy",
107 |
110 |
117 |
120 |
122 |
125 |
127 |             symbol="TSLA",
127 |             symbol="TSLA",
133 |
136 |
15 |
20 |
24 |
26 |         'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'AMD', 'META',
26 |         'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'AMD', 'META',
27 |         'NFLX', 'CRM', 'UBER', 'SHOP', 'PYPL', 'PLTR', 'SPY', 'QQQ',
26 |         'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'AMD', 'META',
27 |         'NFLX', 'CRM', 'UBER', 'SHOP', 'PYPL', 'PLTR', 'SPY', 'QQQ',
30 |
33 |
36 |
40 |
43 |
50 |
58 |
61 |
68 |
70 |             print("✅ TA momentum indicators available")
70 |             print("✅ TA momentum indicators available")
74 |
80 |
93 |
96 |
107 |
111 |
118 |
124 |
130 |
133 |
141 |
147 |
155 |
159 |
20 |
23 |
26 |
32 |
36 |
36 |
39 |
39 |
42 |
45 |
48 |
57 |
61 |
61 |
85 |
89 |
92 |
121 |
124 |
133 |
136 |
139 |
148 |
152 |
152 |
155 |
160 |
163 |
174 |
182 |
185 |
196 |
200 |
10 |
13 |
16 |
27 |
30 |
33 |
37 |
41 |
44 |
53 |
56 |
65 |
68 |
11 | |     OrderSide, OrderType, OrderStatus, RiskLevel,
11 |     OrderSide, OrderType, OrderStatus, RiskLevel,
22 |
29 |
36 |
43 |
56 |
62 |
68 |
78 |
84 |
95 |
107 |
112 |
117 |
122 |
125 |             "MAX_POSITION_SIZE",
129 |
133 |
138 |
145 |
149 |
154 |
161 |
165 |
169 |
173 |
177 |
183 |
193 |
198 |             "RISK_PARAMETERS",
205 |
209 |
216 |
221 |
226 |
229 |
15 |
23 |
23 |
32 |
37 |
41 |
46 |
48 |
53 |
56 |
61 |
65 |
70 |
72 |
88 |
92 |
102 |
111 |
111 |
122 |
127 |
129 |
133 |
133 |
135 |
135 |
140 |
142 |
152 |
155 |
155 |
160 |
162 |
168 |
171 |
171 |
176 |
178 |
185 |
194 |
200 |
202 |
205 |             self.ValidationStatus.APPROVED,
215 |
220 | |                 MarketMicrostructureEngine, BidAskSpreadAnalyzer,
223 |
220 |                 MarketMicrostructureEngine, BidAskSpreadAnalyzer,
223 |
232 |
237 |
241 |
246 |
248 |
256 | …
261 | …
263 |
267 |
272 |
274 | …
279 | …
284 |
286 |
289 |
294 |
296 |
305 |
308 |
312 |
319 |
326 |
333 |
338 |
342 |
347 |
349 |
355 |
357 |
359 |
364 |
369 |
371 |
384 |
389 |
393 |
404 |
410 |
410 |
412 |
412 |
416 |
17 |
21 |
27 |
36 |
43 |
52 |
56 |
65 |
68 |
74 |
79 |
91 |
93 |
97 |
106 |
110 |
114 |
116 |
120 |
128 |
134 |
138 |
142 |
146 |
154 |
156 |
160 |
168 |
172 |
179 |
191 |
193 |
198 |
202 |
206 |
211 |
216 |
221 |
232 |
238 |
242 |
246 |
252 |
255 |
259 |
265 |
274 |
279 |
286 |
289 |
292 |
298 |
301 |
306 |
309 |
312 |
315 |
12 |
12 |
16 |
16 |
25 |
28 |
32 |
36 |
41 |
44 |
51 |
56 |
60 |
61 |         # Check that orders route is configured
60 |
61 |         # Check that orders route is configured
60 |
61 |         # Check that orders route is configured
61 |         # Check that orders route is configured
64 |
64 |
66 |
75 |
79 |
83 |
305 |
17 |
21 |
25 |
30 |
36 |
42 |
48 |
7 | - Technical signal analysis
31 |
35 |
37 |     from ai_trading.position.market_regime import MarketRegimeDetector, MarketRegime
35 |
37 | |     from ai_trading.position.market_regime import MarketRegimeDetector, MarketRegime
37 |     from ai_trading.position.market_regime import MarketRegimeDetector, MarketRegime
47 |
52 |
60 |
64 |
74 |
76 |
85 |
95 |
104 |
107 |
116 |
123 |
123 |
125 |
135 |
140 |
148 |
152 |
154 |
158 |
162 |
169 |
173 |
179 |
184 |
192 |
198 |
200 |
205 |
211 |
217 |
219 |
221 |
228 |
233 |
242 |
244 |
249 |
258 |
262 |
265 |
269 |
278 |
281 |
284 |
291 |
296 |
305 |
309 |
311 |
316 |
325 |
328 |
332 |
339 |
344 |
352 |
354 |
358 |
363 |
366 |
374 |
376 |
384 |
389 |
398 |
403 |
407 |
416 |
420 |
423 |
431 |
433 |
444 |
452 |
456 |
460 |
463 |
466 |
469 |
472 |
21 |
26 |
34 |
38 |
43 |
48 |
57 |
59 |
63 |
74 |
76 |
81 |
85 |
13 |     # Updated test: With our new design, child loggers use propagation
63 |
27 |
27 |
31 |
35 |
39 |
43 |
46 |
54 |
60 |
66 |
75 |
79 |
87 |
91 |
95 |
103 |
108 |
111 |
116 |
119 |
128 |
133 |
135 |
141 |
146 |
151 |
153 |
158 |
163 |
166 |
169 |
169 |
171 |
174 |
179 |
179 |
186 |
189 |
192 |
197 |
199 |
205 |
210 |
213 |
216 |
219 |
224 |
228 |
233 |
238 |
238 |
247 |
261 |
270 |
272 |
276 |
278 |
288 |
291 |
294 |
298 |
303 |
306 |
310 |
310 |
310 |
22 |
30 |
40 |
44 |
48 |
56 |
60 |
65 |
73 |
77 |
83 |
88 |
93 |                 strategy="test_strategy",
97 |
100 |                 model_id,
105 |
113 |
118 |
122 |
127 |
127 |
130 |
135 |
138 |
141 |
15 |
21 |
31 |
36 |
40 |
47 |
51 |
54 |             model_id,
55 |             verify_dataset_hash=True,
54 |             model_id,
55 |             verify_dataset_hash=True,
59 |
73 |
77 |
80 |
84 |
88 |
100 |
103 |
107 |
116 |
120 |
124 |
16 |
19 |
22 |
31 |
34 |
38 |
45 |
48 |
51 |
54 |
61 |
64 |
64 |
68 |
75 |
78 |
81 |
88 |
91 |
94 |
97 |
102 |
112 |
116 |
119 |
125 |
129 | …
134 |
136 |         signals = ["sma_cross", "rsi_oversold", "momentum"]
136 |         signals = ["sma_cross", "rsi_oversold", "momentum"]
139 |
147 |
155 |
158 |
158 |
158 |
11 |
15 |
47 |
67 |
72 |
76 |
80 |
96 |
100 |
107 |
27 |
32 |
11 |
17 |
21 |
21 |
18 |
23 |
23 |
33 |
40 |
40 |
52 |
57 |
57 |
67 |
72 |
72 |
82 |
82 |
86 |
98 |
 98 |
101 |
105 |
106 |         # Verify volatility adjustments are within reasonable bounds
105 |
106 |         # Verify volatility adjustments are within reasonable bounds
105 |
106 |         # Verify volatility adjustments are within reasonable bounds
106 |         # Verify volatility adjustments are within reasonable bounds
109 |
109 |
120 |
123 |
127 |
127 |
136 |
139 |         "MARKET_HOURS", "RISK_PARAMETERS", "KELLY_PARAMETERS",
140 |         "EXECUTION_PARAMETERS", "DATA_PARAMETERS", "DATABASE_PARAMETERS",
139 |         "MARKET_HOURS", "RISK_PARAMETERS", "KELLY_PARAMETERS",
140 |         "EXECUTION_PARAMETERS", "DATA_PARAMETERS", "DATABASE_PARAMETERS",
143 |
19 |
21 |
24 |
31 |
36 |
45 |
47 |
53 |
57 |
62 |
71 |
73 |
80 |
85 |
89 |
89 |
98 |
100 |
106 |
107 |         # Test risk-decreasing change
106 |
107 |         # Test risk-decreasing change
106 |
107 |         # Test risk-decreasing change
111 |
120 |
123 |
125 |         expected_categories = ["kelly_optimization", "risk_optimization",
125 |         expected_categories = ["kelly_optimization", "risk_optimization",
125 |         expected_categories = ["kelly_optimization", "risk_optimization",
127 |
132 |
141 |
144 |
153 |
155 |
160 |
168 |
15 | |
15 |
20 |
24 |
29 |
33 |
45 |
45 |
47 |
51 |             symbol="AAPL",
52 |             quantity=100,
53 |             market_value=15000.0,
51 |             symbol="AAPL",
52 |             quantity=100,
53 |             market_value=15000.0,
54 |             cost_basis=15000.0,
51 |             symbol="AAPL",
52 |             quantity=100,
53 |             market_value=15000.0,
54 |             cost_basis=15000.0,
52 |             quantity=100,
53 |             market_value=15000.0,
54 |             cost_basis=15000.0,
59 |             symbol="GOOGL",
60 |             quantity=50,
61 |             market_value=140000.0,
59 |             symbol="GOOGL",
60 |             quantity=50,
61 |             market_value=140000.0,
62 |             cost_basis=140000.0,
59 |             symbol="GOOGL",
60 |             quantity=50,
61 |             market_value=140000.0,
62 |             cost_basis=140000.0,
60 |             quantity=50,
61 |             market_value=140000.0,
62 |             cost_basis=140000.0,
67 |
70 |             symbol="AAPL",
71 |             quantity=102,
72 |             market_value=15300.0,
70 |             symbol="AAPL",
71 |             quantity=102,
72 |             market_value=15300.0,
73 |             cost_basis=15300.0,
70 |             symbol="AAPL",
71 |             quantity=102,
72 |             market_value=15300.0,
73 |             cost_basis=15300.0,
71 |             quantity=102,
72 |             market_value=15300.0,
73 |             cost_basis=15300.0,
78 |             symbol="MSFT",
79 |             quantity=75,
80 |             market_value=22500.0,
78 |             symbol="MSFT",
79 |             quantity=75,
80 |             market_value=22500.0,
81 |             cost_basis=22500.0,
78 |             symbol="MSFT",
79 |             quantity=75,
80 |             market_value=22500.0,
81 |             cost_basis=22500.0,
79 |             quantity=75,
80 |             market_value=22500.0,
81 |             cost_basis=22500.0,
86 |
89 |
91 |
101 |
103 |
108 |
113 |
123 |
123 |
131 |
136 |
141 |
144 |
149 |
160 |
165 |
171 |
173 |
180 |
188 |
192 |
201 |
201 |
204 |
207 |
211 |
213 |
218 |
221 |
225 |
232 |
234 |
241 |
244 |
250 |
253 |
264 |
264 |
264 |
267 |
271 |
275 |
280 |
284 |
288 |
297 |
297 |
299 |
309 |
314 |
318 |
327 |
340 |
342 |
344 |
352 |
355 |
25 |
25 |
27 |
27 |
30 |
39 |
39 |
42 |
42 |
46 |
53 |
53 |
55 |
55 |
60 |
67 |
74 |
76 |
81 |
84 |
88 |
91 |
91 |
94 |
94 |
101 |
101 |
104 |
104 |
109 |
116 |
119 |
126 |
135 |
139 |
142 |
145 |
148 |
159 |
161 |
17 |     'ALPACA_SECRET_KEY': 'test_secret',
33 |
38 |
45 |
56 |
64 |
70 |
80 |
82 |
86 |
88 |         """Test health summary generation."""
88 |         """Test health summary generation."""
88 |         """Test health summary generation."""
90 |
96 |
100 |             "total_orders", "success_rate", "avg_fill_time",
109 |
112 |
120 |
132 |
134 |
139 |
148 |
154 |
156 |
161 |
171 |
176 |
181 |
197 |
199 |
206 |
216 |
221 |             'ORDER_STALE_CLEANUP_INTERVAL',
225 |
228 |
234 |
243 |
246 |
255 |
261 |
265 |
269 |
272 |
277 |
281 |
284 |
287 |
20 |
24 |
28 |             MockSignal('MSFT', 'sell', 10),  # Small decrease
32 |
39 |
42 |
45 |
49 |
57 |
63 |
66 |
73 |
75 |
83 |
89 |
91 |
101 |
106 |
109 |
112 |
116 |
121 |
127 |
135 |
146 |
153 |
157 |
19 |
45 |
53 |
56 |
64 |
66 |
72 |
78 |
80 |
89 |
96 |
100 |
109 |
113 |
121 |
124 |
132 |
138 |
146 |
158 |
166 |
169 |
177 |
179 |
188 |
191 |
199 |
203 |
210 |
213 |
222 |
229 |
233 |             cost_breakdown.spread_cost +
234 |             cost_breakdown.commission +
235 |             cost_breakdown.market_impact +
233 |             cost_breakdown.spread_cost +
234 |             cost_breakdown.commission +
235 |             cost_breakdown.market_impact +
236 |             cost_breakdown.opportunity_cost +
233 |             cost_breakdown.spread_cost +
234 |             cost_breakdown.commission +
235 |             cost_breakdown.market_impact +
236 |             cost_breakdown.opportunity_cost +
234 |             cost_breakdown.commission +
235 |             cost_breakdown.market_impact +
236 |             cost_breakdown.opportunity_cost +
240 |
250 |
254 |
262 |
268 |
282 |
289 |
294 |
299 |
303 |
305 |
309 |
314 |
322 |
328 |
337 |
343 |
365 |
370 |
378 |
381 |
387 |
395 |
404 |
406 |
409 |
415 |             ('AAPL', 110.0),  # Medium change
419 |
423 |
431 |
438 |
13 |
18 |
24 |
28 |     ctx.data_fetcher.get_daily_df.return_value = Mock()
28 |     ctx.data_fetcher.get_daily_df.return_value = Mock()
30 |
33 |
37 |
37 |
41 |
41 |
50 |
54 |
60 |
66 |
69 |
77 |
82 |
84 |     signal2.symbol = "GOOGL"
84 |     signal2.symbol = "GOOGL"
84 |     signal2.symbol = "GOOGL"
86 |
88 |
91 |
97 |
100 |
111 |
113 |
116 |
121 |
129 |
133 |
138 |
149 |
152 |
152 |
161 |
165 |
169 |
177 |
180 |
188 |     """Test position scoring calculation."""
188 |     """Test position scoring calculation."""
190 |
194 |
200 |
203 |
208 |
218 |     test_signals_enhancement_with_position_logic()
20 |
23 |
27 |
27 |
31 |
31 |
35 |
35 |
41 |
43 |
47 |
52 |
58 |
61 |
63 |
73 |
75 |
81 |
87 |
90 |
97 |
102 |
108 |
115 |
117 |
121 |
128 |         test_position_score_standalone()
17 |
22 |
27 |
27 |
30 |
34 |
38 |
40 |
45 |
48 |
52 |
54 |
58 |
62 |
66 |
70 |
72 |
76 |
80 |
84 |
86 |
90 |
93 |
97 |
101 |
104 |
108 |
112 |
114 |
125 |
130 |
133 |
135 |
138 |
145 |
153 |
160 |
167 |
174 |
180 |
187 |
190 |
198 |
200 |
203 |
206 |
221 |
221 |
20 |
26 |
36 |
41 |
51 |
56 |
66 |
77 |
88 |
106 |
115 |             (3, 3),   # 3 CPUs -> 3 workers
120 |
125 |
130 |
130 |
130 |
28 |
33 |
33 |
38 |
38 |
40 |
51 |
74 |
91 |
97 |
101 |
110 |
114 |
120 |
124 |
129 |
134 |
139 |
2 | Test suite for the critical fixes implemented for Alpaca import hardening,
17 |
20 |
30 |     os.environ['PYTEST_RUNNING'] = '1'
30 |     os.environ['PYTEST_RUNNING'] = '1'
32 |
37 |
51 |
57 |
58 |     # Test core imports
57 |
58 |     # Test core imports
62 |
74 |
78 |
78 |
82 |         symbol="AAPL",
87 |
 99 |
102 |
105 |
119 |
122 |
125 |
128 |
131 |
139 |
143 |
150 |
153 |
157 |     assert 'ALPACA_SECRET_KEY=' in content, "Should have Alpaca secret placeholder"
157 |     assert 'ALPACA_SECRET_KEY=' in content, "Should have Alpaca secret placeholder"
159 |
163 |
170 |
175 |
178 |
178 |
186 |         test_alpaca_import_exception_handling,
195 |
197 |
200 |
210 |
212 |
7 | 2. Improved process detection logic
24 |
30 |
35 |
39 |
43 |
52 |
56 |
65 |
73 |
81 |
92 |
95 |
100 |
109 |
111 |
122 |
128 | |                 is_market_hours, get_staleness_threshold,
128 |                 is_market_hours, get_staleness_threshold,
137 |
143 |
144 |         # Test outside market hours (Tuesday 6:00 PM ET = 11:00 PM UTC)
143 |
144 |         # Test outside market hours (Tuesday 6:00 PM ET = 11:00 PM UTC)
147 |
151 |
158 |
163 |
168 |
174 |
179 |
181 |
191 |
200 |
204 |
210 |
213 |
219 |
227 |
229 |
236 |
242 |
246 |
255 |
262 |
266 |
269 |
274 |             'data_validation',
277 |
26 |         MODERATE = "moderate"
26 |         MODERATE = "moderate"
28 |
32 |
42 |
45 |
50 |
52 |
55 |
58 |
64 |
64 |
66 |
79 |
79 |
79 |
82 |
86 |
90 |
94 |
100 |
102 |
115 |
117 |
122 |
129 |
135 |
141 |
143 |
156 |
158 |
161 |
169 |
172 |
180 |
183 |
188 |
192 |
194 |
208 |
208 |
214 |
223 |
226 |
226 |
232 |
236 |
238 |
250 |
252 |
258 |
261 |
261 |
265 |
268 |
275 |
278 |
283 |
18 |
21 |
25 |
35 |
38 |
48 |
51 |
60 |
71 |
71 |
74 |
79 |
95 |
104 |
104 |
116 |
35 |
39 |
49 |
7 |
 7 |
16 |
21 |         'high': [102, 103, 104],
26 |
33 |
39 |     """Test that _regime_basket_to_proxy_bars creates proper output."""
61 |
13 |
17 |
20 |
14 |
17 |
23 |
31 |
36 |
52 |
56 |
59 |
65 |
80 |
87 |
93 |
96 |
106 |
110 |
115 |
125 |
128 |         "symbol": "TSLA",
132 |
136 |
139 |
143 |
153 |
160 |
165 |
168 |
180 |
184 |
188 |
71 |
77 |
11 |
15 |
19 |
23 |
30 |
37 |
41 |
44 |
51 |
56 |
60 |
62 |
66 |
68 |
72 |
74 |
80 |
85 |
87 |
13 |
21 |
22 |     # Test indicators import
21 |
22 |     # Test indicators import
28 |
38 |
44 |
48 |
65 |
70 |
73 |
80 |
87 |
95 |
103 |
109 |
112 |
119 |
128 |
136 |
143 |
145 |
152 |
155 |
4 | Validates that TradingConfig and build_runtime ensure all required
15 |
17 |
22 |
32 |
39 |
42 |
61 |
61 |
64 |
68 |
72 |
83 |
83 |
93 |
95 |
109 |
109 |
113 |
121 |
125 |
130 |
140 |
140 |
143 |
146 |
155 |
155 |
158 |
11 |
20 |
29 |
43 |
47 |
57 |
13 |
16 |
20 |
23 |
24 |
31 |
36 |
39 |
44 |
48 |
51 |
56 |
59 |
62 |
62 |
66 |
70 |
73 |
76 |
80 |
84 |
88 |
91 |
98 |
 98 |
 98 |
105 |
110 |
110 |
114 |
116 |
122 |
126 |
130 |
133 |
138 |
141 |
148 |
151 |
155 |
162 |
169 |
169 |
178 |
184 |
191 |
18 |
22 |
26 |             'high': [101.0],
32 |
36 |
43 |
49 |
53 |
58 |             'low': [99.0],
63 |
67 |
75 |
79 |
87 |
91 |
 99 |
101 |
112 |                 # Stale data for MSFT
121 |
124 |
128 |
137 |
137 |
142 |
147 |
150 |
153 |
158 |
165 |
167 | …
174 |
175 |         # Test with timezone-aware timestamp
174 |
175 |         # Test with timezone-aware timestamp
175 |         # Test with timezone-aware timestamp
178 |             'timestamp': [aware_timestamp],
178 |             'timestamp': [aware_timestamp],
181 |
183 |
197 |
201 |
205 |
17 |
21 |
24 |
28 |
30 |
43 |
46 |
51 |
56 |
58 |     out3 = alloc.select_signals({"s": [sell]})  # Third sell call - blocked by hold_protect (remaining=2)
58 |     out3 = alloc.select_signals({"s": [sell]})  # Third sell call - blocked by hold_protect (remaining=2)
58 |     out3 = alloc.select_signals({"s": [sell]})  # Third sell call - blocked by hold_protect (remaining=2)
58 |     out3 = alloc.select_signals({"s": [sell]})  # Third sell call - blocked by hold_protect (remaining=2)
60 |
60 |
63 |
63 |
66 |
15 |
19 |
24 |
29 |
31 |
35 |
41 |
45 |
50 |
54 |
57 |
59 |
63 |
67 |
71 |
76 |
80 |
82 |
86 |
90 |
94 |
106 |
112 |
114 |
117 |
123 |
123 |
127 |
135 |
138 |
141 |
145 |
151 |
153 |
156 |
160 |
164 |
173 |
175 |
178 |
20 |
25 |
30 |
30 |
32 |
36 |
40 |
21 |
23 |
27 |
30 |
40 |
49 |
49 |
52 |
56 |
61 |
64 |
70 |
74 |
79 |
83 |
85 |
98 |
98 |
98 |
 98 |
101 |
104 |
107 |
113 |
117 |
120 |
125 |
125 |
131 |
133 |
148 |
148 |
152 |
155 |
158 |
162 |
166 |
173 |
182 |
188 |
190 |
203 |
205 |
210 |
212 |
217 |
219 |
228 |
230 |
235 |
242 |
245 |
247 |
259 |
261 |
267 |
271 |
274 |
281 |
284 |
289 |
39 |
42 |
49 |
55 |
64 |
68 |
75 |
102 |
114 |
31 |
31 |
35 |
41 |
45 |
56 |
56 |
70 |
70 |
75 |
79 |
84 |
87 |
90 |
102 |
102 |
107 |
111 |
116 |
120 |
17 |
33 |
36 |
39 |
46 |
52 |
54 |
64 |
69 |
79 |
83 |
87 |
90 |
 99 |
103 |
104 |         # Test APCA_* schema
103 |
104 |         # Test APCA_* schema
110 |
114 |
130 |
134 | …
138 |
149 | assert secret_key == "test_apca_secret_from_env"
153 |
157 | …
161 |
165 |
193 |
197 | …
204 |
207 |
222 | assert hasattr(runner, '_bot_engine')
231 |
235 | …
242 |
17 |
22 |
27 |
 8 |
12 |
16 |
19 |
23 |
28 |             if (isinstance(node.func, ast.Name) and
31 |
34 |
42 |
50 |
56 |
65 |
71 |
75 |
78 |
84 |
21 |
29 |
30 |     # Trading Mode Parameters
29 |
30 |     # Trading Mode Parameters
38 |
70 |
74 |
77 |             'symbol': 'TEST',
78 |             'qty': 10,
79 |             'side': 'buy',
77 |             'symbol': 'TEST',
78 |             'qty': 10,
79 |             'side': 'buy',
80 |             'price': 100.0,
77 |             'symbol': 'TEST',
78 |             'qty': 10,
79 |             'side': 'buy',
80 |             'price': 100.0,
81 |             'timestamp': '2025-08-05T23:17:35Z',
78 |             'qty': 10,
79 |             'side': 'buy',
80 |             'price': 100.0,
81 |             'timestamp': '2025-08-05T23:17:35Z',
82 |             'order_id': 'test-001',
79 |             'side': 'buy',
80 |             'price': 100.0,
81 |             'timestamp': '2025-08-05T23:17:35Z',
82 |             'order_id': 'test-001',
80 |             'price': 100.0,
81 |             'timestamp': '2025-08-05T23:17:35Z',
82 |             'order_id': 'test-001',
85 |
91 |
95 |
110 |
114 |
117 |             'symbol': 'TEST',
118 |             'qty': 10,
119 |             'side': 'buy',
117 |             'symbol': 'TEST',
118 |             'qty': 10,
119 |             'side': 'buy',
120 |             'price': 100.0,
117 |             'symbol': 'TEST',
118 |             'qty': 10,
119 |             'side': 'buy',
120 |             'price': 100.0,
121 |             'timestamp': '2025-08-05T23:17:35Z',
118 |             'qty': 10,
119 |             'side': 'buy',
120 |             'price': 100.0,
121 |             'timestamp': '2025-08-05T23:17:35Z',
122 |             'order_id': 'test-001',
119 |             'side': 'buy',
120 |             'price': 100.0,
121 |             'timestamp': '2025-08-05T23:17:35Z',
122 |             'order_id': 'test-001',
120 |             'price': 100.0,
121 |             'timestamp': '2025-08-05T23:17:35Z',
122 |             'order_id': 'test-001',
125 |
131 |
135 |
149 |
153 |
156 |             'symbol': 'TEST',
157 |             'qty': 10,
158 |             'side': 'buy',
156 |             'symbol': 'TEST',
157 |             'qty': 10,
158 |             'side': 'buy',
159 |             'price': 100.0,
156 |             'symbol': 'TEST',
157 |             'qty': 10,
158 |             'side': 'buy',
159 |             'price': 100.0,
160 |             'timestamp': '2025-08-05T23:17:35Z',
157 |             'qty': 10,
158 |             'side': 'buy',
159 |             'price': 100.0,
160 |             'timestamp': '2025-08-05T23:17:35Z',
161 |             'order_id': 'test-001',
158 |             'side': 'buy',
159 |             'price': 100.0,
160 |             'timestamp': '2025-08-05T23:17:35Z',
161 |             'order_id': 'test-001',
159 |             'price': 100.0,
160 |             'timestamp': '2025-08-05T23:17:35Z',
161 |             'order_id': 'test-001',
164 |
168 |
172 |
182 |
184 |         'symbol': 'TEST',
184 |         'symbol': 'TEST',
185 |         'qty': 10,
186 |         'side': 'buy',
184 |         'symbol': 'TEST',
185 |         'qty': 10,
186 |         'side': 'buy',
187 |         'price': 100.0,
184 |         'symbol': 'TEST',
185 |         'qty': 10,
186 |         'side': 'buy',
187 |         'price': 100.0,
188 |         'timestamp': '2025-08-05T23:17:35Z',
185 |         'qty': 10,
186 |         'side': 'buy',
187 |         'price': 100.0,
188 |         'timestamp': '2025-08-05T23:17:35Z',
189 |         'order_id': 'test-001',
186 |         'side': 'buy',
187 |         'price': 100.0,
188 |         'timestamp': '2025-08-05T23:17:35Z',
189 |         'order_id': 'test-001',
187 |         'price': 100.0,
188 |         'timestamp': '2025-08-05T23:17:35Z',
189 |         'order_id': 'test-001',
192 |
208 |
211 |
213 |             'symbol': 'TEST',
213 |             'symbol': 'TEST',
214 |             'qty': 10,
215 |             'side': 'buy',
213 |             'symbol': 'TEST',
214 |             'qty': 10,
215 |             'side': 'buy',
216 |             'price': 100.0,
213 |             'symbol': 'TEST',
214 |             'qty': 10,
215 |             'side': 'buy',
216 |             'price': 100.0,
217 |             'timestamp': '2025-08-05T23:17:35Z',
214 |             'qty': 10,
215 |             'side': 'buy',
216 |             'price': 100.0,
217 |             'timestamp': '2025-08-05T23:17:35Z',
218 |             'order_id': 'test-001',
215 |             'side': 'buy',
216 |             'price': 100.0,
217 |             'timestamp': '2025-08-05T23:17:35Z',
218 |             'order_id': 'test-001',
216 |             'price': 100.0,
217 |             'timestamp': '2025-08-05T23:17:35Z',
218 |             'order_id': 'test-001',
221 |
227 |
231 |
20 |
24 |
28 |
32 |
38 |
42 |
45 |
50 |
53 |
58 |
61 |
68 |
71 |
75 |
79 |
84 |
89 |
 98 |
103 |
107 |
113 |
119 |
125 |
131 |
135 |
139 |
143 |
146 |
149 |
152 |
156 |
163 |
169 |
174 |
179 |
184 |
189 |
20 |
24 |
25 |     # Create a simple order request object
24 |
25 |     # Create a simple order request object
32 |
37 |
 9 |
12 |
17 |
18 |     # Test that it works when ctx doesn't have min_rows attribute
17 |
18 |     # Test that it works when ctx doesn't have min_rows attribute
22 |
23 | @pytest.mark.unit
22 |
23 | @pytest.mark.unit
31 |
36 |
39 |
75 |
25 |
10 |
22 |
23 |         # Integers
22 |
23 |         # Integers
28 |
38 |
42 |
49 |
52 |
20 |
29 |
45 |
59 |
68 |
73 |
77 |
106 |
124 |
13 |
16 |             isinstance(h.type, cst.Name) and h.type.value == "ImportError"
20 |
24 |
39 |
17 |
29 |
49 |
52 |
