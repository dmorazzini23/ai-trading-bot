# =========================================
# AI Trading Bot - Production .env (clean)
# Notes:
# - No ${VAR} indirection: systemd does NOT expand it in EnvironmentFile.
# - Alpaca IEX is the primary data source; Yahoo is backup.
# - Trading (orders/account) and Market Data use different base URLs.
# =========================================

# ===== REQUIRED BROKER SECRETS =====
ALPACA_API_KEY=
ALPACA_SECRET_KEY=

# ===== ALPACA HOSTS (no indirection) =====
# Trading API (paper)
ALPACA_TRADING_BASE_URL=https://paper-api.alpaca.markets
# Keep these for backward-compat if any code still reads them
ALPACA_BASE_URL=https://paper-api.alpaca.markets
ALPACA_API_URL=https://paper-api.alpaca.markets

# Market Data API (IEX/SIP lives here, not on trading host)
ALPACA_DATA_BASE_URL=https://data.alpaca.markets
ALPACA_DATA_FEED=iex
ALPACA_ADJUSTMENT=all
ALPACA_HAS_SIP=0
ALPACA_ALLOW_SIP=0
ALPACA_FEED_FAILOVER=yahoo

# ===== DATA FEED & PROVIDERS =====
# Primary provider: Alpaca IEX. Backup: Yahoo (yfinance).
DATA_PROVIDER=alpaca
DATA_PROVIDER_PRIORITY=alpaca_iex,yahoo
DAILY_SOURCE=auto
MINUTE_SOURCE=alpaca
BACKUP_PROVIDER=yahoo

AI_TRADING_PROVIDER_SWITCH_COOLDOWN_SEC=240
AI_TRADING_PROVIDER_HEALTH_PASSES_REQUIRED=2
AI_TRADING_SAFE_MODE=0
AI_TRADING_SAFE_MODE_ALLOW_PAPER=1

# (Optional legacy knob; keep aligned if referenced)
DATA_FEED_INTRADAY=iex

# Cache TTL settings
MINUTE_CACHE_TTL=300
MARKET_CACHE_TTL=86400

# Global request budget (requests per minute)
ALPACA_RATE_LIMIT_PER_MIN=200

# Conservative host concurrency for Basic plan (single, canonical knob for tests)
AI_TRADING_HTTP_HOST_LIMIT=3

# ===== OPTIONAL PROVIDERS =====
# Disable Finnhub for now to avoid mixed-provider surprises; re-enable if needed.
ENABLE_FINNHUB=0
#FINNHUB_API_KEY=

NEWS_API_KEY=
SENTIMENT_API_KEY=
SENTIMENT_API_URL=https://newsapi.org/v2/everything
SENTIMENT_MAX_CALLS_PER_MIN=6
SENTIMENT_SUCCESS_TTL_SEC=3600

# ===== SECURITY =====
WEBHOOK_SECRET=

# ===== RUNTIME / SERVER =====
API_HOST=0.0.0.0
API_PORT=9001
HEALTHCHECK_PORT=8081
AI_TRADING_HEALTH_TICK_SECONDS=300
TZ=UTC
MARKET_CALENDAR=XNYS
EXECUTION_MODE=paper
EXECUTION_SAFE_MODE=0
SHADOW_MODE=0
# Broker adapter selection (`alpaca` default; optional `tradier`)
AI_TRADING_BROKER_PROVIDER=alpaca
# Optional Tradier adapter credentials (used only when provider=tradier)
TRADIER_ACCESS_TOKEN=
TRADIER_ACCOUNT_ID=
TRADIER_BASE_URL=https://api.tradier.com/v1
TRADIER_TIMEOUT_SECONDS=10

# ===== LOOP / SCHEDULING =====
AI_TRADING_INTERVAL=300
AI_TRADING_ITERATIONS=0
AI_TRADING_SEED=42
INTERVAL_WHEN_CLOSED=30
AI_TRADING_WARMUP_ALLOW_ORDERS=0
AI_TRADING_WARMUP_SYMBOL_LIMIT=5
MAX_SYMBOLS_PER_CYCLE=5
AI_TRADING_PREPARE_SYMBOL_LIMIT=5
EXECUTION_MAX_NEW_ORDERS_PER_CYCLE=4
AI_TRADING_EXEC_CANDIDATE_TOP_N=5
AI_TRADING_ACK_FIRST_RECONCILE_ENABLED=1
ORDER_ACK_TIMEOUT_SECONDS=8
AI_TRADING_PENDING_ORDERS_BLOCK_SCOPE=symbol
AI_TRADING_PENDING_NEW_POLICY=replace_widen
AI_TRADING_PENDING_NEW_TIMEOUT_SEC=30
AI_TRADING_PENDING_NEW_MAX_ACTIONS_PER_CYCLE=2
AI_TRADING_PENDING_NEW_REPLACE_WIDEN_BPS=18
AI_TRADING_PENDING_SYMBOL_DECAY_ENABLED=1
AI_TRADING_PENDING_SYMBOL_DECAY_ACK_MULT=8
AI_TRADING_PENDING_SYMBOL_DECAY_MIN_SEC=45
AI_TRADING_PENDING_SYMBOL_DECAY_MAX_SEC=300
AI_TRADING_PENDING_SYMBOL_DECAY_MIN_CYCLES=2
AI_TRADING_PENDING_SYMBOL_RELEASE_COOLDOWN_SEC=120
AI_TRADING_PENDING_POLICY_APPLIED_LOG_TTL_SEC=180
AI_TRADING_PENDING_SYMBOL_BLOCK_ACTIVE_LOG_TTL_SEC=180
AI_TRADING_PENDING_SYMBOL_COOLDOWN_TELEMETRY_LOG_TTL_SEC=120
AI_TRADING_PENDING_SYMBOL_COOLDOWN_TELEMETRY_SAMPLE_LIMIT=8
AI_TRADING_NETTING_CYCLE_SLO_LOG_TTL_SEC=180
AI_TRADING_ORDER_SKIP_LOG_TTL_SEC=120
AI_TRADING_ORDER_SKIP_DETAIL_LOG_TTL_SEC=180
DATA_SOURCE_RETRY_ATTEMPTS=1
DATA_SOURCE_RETRY_DELAY_SECONDS=0
AI_TRADING_DATA_RETRY_FLATTEN_ENABLED=1
AI_TRADING_DATA_RETRY_FLATTEN_MAX_ATTEMPTS=1
AI_TRADING_DATA_RETRY_FLATTEN_MAX_DELAY_SECONDS=0
FETCH_BARS_MAX_RETRIES=1
FETCH_BARS_BACKOFF_BASE=1
FETCH_BARS_BACKOFF_CAP=1
AI_TRADING_SCREEN_ROTATE_UNSEEN_ENABLED=0
AI_TRADING_SCREEN_CYCLE_BUDGET_MS=12000
AI_TRADING_SCREEN_INTER_SYMBOL_SLEEP_SEC=0
AI_TRADING_ADAPTIVE_ORDER_CAP_ENABLED=1
AI_TRADING_ADAPTIVE_ORDER_CAP_WARN_HEADROOM_RATIO=0.40
AI_TRADING_ADAPTIVE_ORDER_CAP_CRIT_HEADROOM_RATIO=0.20
AI_TRADING_ADAPTIVE_ORDER_CAP_WARN_VALUE=2
AI_TRADING_ADAPTIVE_ORDER_CAP_CRIT_VALUE=1
AI_TRADING_PENDING_BACKLOG_CAP_THRESHOLD=5
AI_TRADING_PENDING_BACKLOG_CAP_VALUE=2
AI_TRADING_INTENT_BLOCK_WHEN_OPEN_ORDER=1
AI_TRADING_ENGINE_HEALTHCHECK_SEC=120
AI_TRADING_ENGINE_INIT_COOLDOWN_SEC=30
AI_TRADING_NETTING_FETCH_MAX_ATTEMPTS=2
AI_TRADING_EVENT_DRIVEN_NEW_BAR_ONLY=1
AI_TRADING_SCORE_FAST_BARS=3
AI_TRADING_SCORE_SLOW_BARS=12
AI_TRADING_SCORE_VOL_BARS=30
AI_TRADING_SCORE_FAST_WEIGHT=0.65
AI_TRADING_SCORE_Z_CLIP=3.0
AI_TRADING_SCORE_MIN_ABS=0.04
AI_TRADING_EDGE_COST_STRICT_GATE_ENABLED=1
AI_TRADING_EDGE_COST_MIN_RATIO=1.15
AI_TRADING_EDGE_MIN_EXPECTED_BPS=6.0
ORDER_STALE_CLEANUP_INTERVAL=60
AI_TRADING_STARTUP_CANCEL_MODE=stale_only
AI_TRADING_STARTUP_CANCEL_STALE_SEC=60
AI_TRADING_PENDING_CLEANUP_WARMUP_CYCLES=0
AI_TRADING_EXECUTION_PHASE_GATE_ENABLED=1
AI_TRADING_EXECUTION_PHASE_BLOCKED=bootstrap,reconcile
AI_TRADING_BOOTSTRAP_ORDER_CAP_ENABLED=1
AI_TRADING_BOOTSTRAP_MAX_NEW_ORDERS_PER_CYCLE=2
AI_TRADING_BOOTSTRAP_CAP_CYCLES=2
AI_TRADING_BOOTSTRAP_CAP_SECONDS=180
AI_TRADING_MARKET_SNAPSHOT_EVERY_N_CYCLES=1
AI_TRADING_MARKET_SNAPSHOT_EVERY_N_CYCLES_CLOSED=5
AI_TRADING_CYCLE_SLO_ALERTS_ENABLED=1
AI_TRADING_SLO_CYCLE_COMPUTE_WARN_MS=30000
AI_TRADING_SLO_CYCLE_COMPUTE_CRIT_MS=60000
AI_TRADING_SLO_CYCLE_COMPUTE_WARN_MS_CLOSED=120000
AI_TRADING_SLO_CYCLE_COMPUTE_CRIT_MS_CLOSED=240000
AI_TRADING_SLO_PROVIDER_TELEMETRY_STALE_WARN_SEC=300
AI_TRADING_MARKET_CLOSED_SKIP_LOG_TTL_SEC=300
AI_TRADING_CLOSED_CYCLE_DETAIL_LOG_TTL_SEC=300
AI_TRADING_MIDPOINT_LIMIT_MAX_OFFSET_BPS=16
AI_TRADING_MIDPOINT_LIMIT_MIN_OFFSET_BPS=2
AI_TRADING_MIDPOINT_LIMIT_HARD_CAP_BPS=25

# ===== PATHS / ARTIFACTS =====
AI_TRADING_RL_MODEL_PATH=models/runtime/rl_agent.zip
HALT_FLAG_PATH=halt.flag
AI_TRADING_MODEL_MODULE=ai_trading.simple_models
# Optional explicit path for promoted ML artifacts.
#AI_TRADING_MODEL_PATH=/home/aiuser/ai-trading-bot/models/runtime/ml_latest.joblib
AI_TRADING_AFTER_HOURS_RUNTIME_MODEL_PATH=models/runtime/ml_latest.joblib

# ===== STRATEGY / MODES =====
TRADING_MODE=balanced
USE_RL_AGENT=0
CPU_ONLY=1

# ===== RL OVERLAY / GOVERNANCE =====
AI_TRADING_AFTER_HOURS_RL_OVERLAY_ENABLED=0
AI_TRADING_RL_SB3_VERBOSE=0
AI_TRADING_RL_CALLBACK_VERBOSE=0
AI_TRADING_AFTER_HOURS_RL_ALGO=PPO
AI_TRADING_AFTER_HOURS_RL_TIMESTEPS=15000
AI_TRADING_AFTER_HOURS_RL_DIR=models/after_hours_rl
AI_TRADING_AFTER_HOURS_PROMOTE_RL_PATH=1
AI_TRADING_AFTER_HOURS_RUNTIME_RL_MODEL_PATH=models/runtime/rl_agent.zip
AI_TRADING_AFTER_HOURS_RL_MULTI_SEED_ENABLED=0
AI_TRADING_AFTER_HOURS_RL_MULTI_SEEDS=11,23,37

AI_TRADING_RL_FEATURE_WINDOW=10
AI_TRADING_RL_TRANSACTION_COST=0.001
AI_TRADING_RL_SLIPPAGE=0.0005
AI_TRADING_RL_HALF_SPREAD=0.0002
AI_TRADING_RL_MIN_MEAN_REWARD=0.0
AI_TRADING_RL_MIN_AVG_NET_RETURN=0.0
AI_TRADING_RL_MAX_EVAL_DRAWDOWN=0.25
AI_TRADING_RL_MAX_CONSTRAINT_VIOLATION_RATE=0.0
AI_TRADING_RL_MAX_CONSTRAINT_TERMINATION_RATE=0.0
AI_TRADING_RL_AUTO_PROMOTE=0
AI_TRADING_RL_REQUIRE_BASELINE_EXPECTANCY_BPS=1.0
AI_TRADING_ML_USE_REGIME_THRESHOLDS=1
AI_TRADING_MODEL_LIVENESS_ENABLED=1
AI_TRADING_MODEL_LIVENESS_REQUIRE_MARKET_OPEN=1
AI_TRADING_MODEL_LIVENESS_ALERT_COOLDOWN_SECONDS=300
AI_TRADING_ML_SIGNAL_MAX_AGE_SECONDS=5400
AI_TRADING_RL_SIGNAL_MAX_AGE_SECONDS=5400
AI_TRADING_AFTER_HOURS_AUTO_PROMOTE=1
AI_TRADING_AFTER_HOURS_PROMOTION_POLICY=strict
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_ROWS=800
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_SUPPORT=60
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_FOLDS=4
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_HIT_RATE=0.49
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_PROFITABLE_FOLDS=2
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_PROFITABLE_FOLD_RATIO=0.40
AI_TRADING_AFTER_HOURS_PROMOTION_REQUIRE_SENSITIVITY=0
AI_TRADING_AFTER_HOURS_PROMOTION_REQUIRE_PRIOR_IMPROVEMENT=1
AI_TRADING_AFTER_HOURS_PROMOTION_DRAWDOWN_PENALTY=0.003
AI_TRADING_AFTER_HOURS_PROMOTION_MIN_SCORE_MARGIN=0.10
AI_TRADING_AFTER_HOURS_SENSITIVITY_SWEEP_ENABLED=1
AI_TRADING_AFTER_HOURS_SWEEP_MIN_PASS_RATIO=0.45
AI_TRADING_AFTER_HOURS_SWEEP_MAX_EXPECTANCY_STD_BPS=8.0
AI_TRADING_AFTER_HOURS_SWEEP_MIN_SCENARIO_EXPECTANCY_BPS=0.5
AI_TRADING_AFTER_HOURS_THRESHOLD_DRAWDOWN_PENALTY=0.003
AI_TRADING_AFTER_HOURS_THRESHOLD_MIN_EXPECTANCY_BPS=0.0
AI_TRADING_EDGE_TARGET_EXPECTANCY_BPS=0.5
AI_TRADING_EDGE_TARGET_MAX_DRAWDOWN_BPS=650
AI_TRADING_EDGE_TARGET_MAX_TURNOVER_RATIO=0.35
AI_TRADING_EDGE_TARGET_MIN_HIT_RATE_STABILITY=0.55
AI_TRADING_AFTER_HOURS_TRAINING_ONCE_PER_DAY=1
AI_TRADING_AFTER_HOURS_TRAINING_CATCHUP_ENABLED=1
AI_TRADING_AFTER_HOURS_TRAINING_MARKER_PATH=runtime/after_hours_training.marker.json
AI_TRADING_AFTER_HOURS_TRAINING_MAX_AGE_SECONDS=129600

# ===== SESSION / GATES =====
RTH_ONLY=1
ALLOW_EXTENDED=0

# Feature flags for institutional netting pipeline
AI_TRADING_NETTING_ENABLED=1
AI_TRADING_DATA_CONTRACT_ENABLED=1
AI_TRADING_RECON_ENABLED=1
AI_TRADING_LEDGER_ENABLED=1

# Canary (disabled by default)
AI_TRADING_CANARY_SYMBOLS=
AI_TRADING_CANARY_MAX_GROSS_DOLLARS=0
AI_TRADING_CANARY_AUTO_ROLLBACK_ENABLED=1
AI_TRADING_CANARY_ROLLBACK_ON_MODEL_LIVENESS_BREACH=1
AI_TRADING_CANARY_ROLLBACK_COOLDOWN_SECONDS=1800
AI_TRADING_CANARY_ROLLBACK_FLAG_PATH=runtime/canary_rollback.flag
AI_TRADING_CANARY_ROLLBACK_SET_KILL_SWITCH=1
AI_TRADING_CANARY_ROLLBACK_COMMAND=
AI_TRADING_CANARY_ROLLBACK_COMMAND_TIMEOUT_SECONDS=30

# Kill switch (env + file)
AI_TRADING_KILL_SWITCH=0
AI_TRADING_KILL_SWITCH_PATH=runtime/kill_switch

# Decision records + OMS ledger
AI_TRADING_DECISION_LOG_PATH=runtime/decision_records.jsonl
AI_TRADING_LEDGER_PATH=runtime/oms_ledger.jsonl
AI_TRADING_LEDGER_LOOKBACK_HOURS=24
AI_TRADING_RECON_INTERVAL_SECONDS=300

# ===== RISK & POSITION SIZING =====
CAPITAL_CAP=0.06
DOLLAR_RISK_LIMIT=0.05
AI_TRADING_MAX_DRAWDOWN_THRESHOLD=0.08
AI_TRADING_MAX_PORTFOLIO_POSITIONS=10
AI_TRADING_MAX_POSITION_SIZE=25000
MAX_POSITION_MODE=AUTO

# ===== MULTI-HORIZON NETTING =====
AI_TRADING_HORIZONS=day:5Min,swing:1Hour,longshort:1Day

AI_TRADING_SLEEVE_DAY_ENABLED=1
AI_TRADING_SLEEVE_DAY_ENTRY_THRESHOLD=0.2
AI_TRADING_SLEEVE_DAY_EXIT_THRESHOLD=0.1
AI_TRADING_SLEEVE_DAY_FLIP_THRESHOLD=0.35
AI_TRADING_SLEEVE_DAY_REENTRY_THRESHOLD=0.6
AI_TRADING_SLEEVE_DAY_DEADBAND_DOLLARS=50
AI_TRADING_SLEEVE_DAY_DEADBAND_SHARES=1
AI_TRADING_SLEEVE_DAY_TURNOVER_CAP=20000
AI_TRADING_SLEEVE_DAY_COST_K=1.5
AI_TRADING_SLEEVE_DAY_EDGE_SCALE_BPS=25
AI_TRADING_SLEEVE_DAY_MAX_SYMBOL_DOLLARS=10000
AI_TRADING_SLEEVE_DAY_MAX_GROSS_DOLLARS=50000

AI_TRADING_SLEEVE_SWING_ENABLED=1
AI_TRADING_SLEEVE_SWING_ENTRY_THRESHOLD=0.2
AI_TRADING_SLEEVE_SWING_EXIT_THRESHOLD=0.1
AI_TRADING_SLEEVE_SWING_FLIP_THRESHOLD=0.3
AI_TRADING_SLEEVE_SWING_REENTRY_THRESHOLD=0.55
AI_TRADING_SLEEVE_SWING_DEADBAND_DOLLARS=75
AI_TRADING_SLEEVE_SWING_DEADBAND_SHARES=1
AI_TRADING_SLEEVE_SWING_TURNOVER_CAP=30000
AI_TRADING_SLEEVE_SWING_COST_K=1.4
AI_TRADING_SLEEVE_SWING_EDGE_SCALE_BPS=20
AI_TRADING_SLEEVE_SWING_MAX_SYMBOL_DOLLARS=15000
AI_TRADING_SLEEVE_SWING_MAX_GROSS_DOLLARS=60000

AI_TRADING_SLEEVE_LONGSHORT_ENABLED=1
AI_TRADING_SLEEVE_LONGSHORT_ENTRY_THRESHOLD=0.2
AI_TRADING_SLEEVE_LONGSHORT_EXIT_THRESHOLD=0.1
AI_TRADING_SLEEVE_LONGSHORT_FLIP_THRESHOLD=0.3
AI_TRADING_SLEEVE_LONGSHORT_REENTRY_THRESHOLD=0.55
AI_TRADING_SLEEVE_LONGSHORT_DEADBAND_DOLLARS=100
AI_TRADING_SLEEVE_LONGSHORT_DEADBAND_SHARES=1
AI_TRADING_SLEEVE_LONGSHORT_TURNOVER_CAP=40000
AI_TRADING_SLEEVE_LONGSHORT_COST_K=1.3
AI_TRADING_SLEEVE_LONGSHORT_EDGE_SCALE_BPS=18
AI_TRADING_SLEEVE_LONGSHORT_MAX_SYMBOL_DOLLARS=20000
AI_TRADING_SLEEVE_LONGSHORT_MAX_GROSS_DOLLARS=80000

GLOBAL_MAX_SYMBOL_DOLLARS=25000
GLOBAL_MAX_GROSS_DOLLARS=150000
GLOBAL_MAX_NET_DOLLARS=75000
DISAGREE_RATIO_THRESHOLD=0.35

# ===== WORKERS / PERFORMANCE =====
AI_TRADING_ENABLE_MEMORY_OPTIMIZATION=1
AI_TRADING_EXEC_WORKERS=1
AI_TRADING_PRED_WORKERS=1
EXEC_WORKERS_WHEN_CLOSED=1
DYNAMIC_SIZE_REFRESH_SECS=1800
CYCLE_BUDGET_FRACTION=0.9

# ===== HTTP CLIENT TUNING (Basic-plan safe) =====
HTTP_MAX_WORKERS=3
HTTP_POOL_MAXSIZE=16

HTTP_TIMEOUT_S=10
HTTP_TOTAL_RETRIES=2
HTTP_BACKOFF_FACTOR=0.3
HTTP_CONNECT_TIMEOUT=4.0
HTTP_READ_TIMEOUT=12.0
HTTP_CONNECT_TIMEOUT_CLOSED=3.0
HTTP_READ_TIMEOUT_CLOSED=6.0

# Per-host vendor caps (tightened for Alpaca Basic)
# paper-api.alpaca.markets
HTTP_RPS_LIMIT_paper_api_alpaca_markets=2
HTTP_RETRIES_paper_api_alpaca_markets=2
HTTP_BACKOFF_paper_api_alpaca_markets=0.2
# data.alpaca.markets (add explicit limits for market data host)
HTTP_RPS_LIMIT_data_alpaca_markets=4
HTTP_RETRIES_data_alpaca_markets=2
HTTP_BACKOFF_data_alpaca_markets=0.2
# finnhub.io (kept for future use)
HTTP_RPS_LIMIT_finnhub_io=5

# ===== LOGGING =====
LOG_LEVEL=INFO
LOG_LEVEL_HTTP=INFO
AI_TRADING_LOG_TIMINGS_LEVEL=INFO
AI_TRADING_LOG_RATE_LIMIT_WINDOW_SEC=120
AI_TRADING_EXEC_DEBUG=1
AI_TRADING_EXEC_LOG_REQUESTS=1
AI_TRADING_EXEC_LOG_RAW_RESPONSES=1
AI_TRADING_EXEC_STRICT=1
EXECUTION_STRICT_READINESS=0

# ===== DATA QUALITY / PROVIDER DECISIONS =====
AI_TRADING_GAP_RATIO_LIMIT=0.03
AI_TRADING_GAP_LIMIT_BPS=500
AI_TRADING_NBBO_GAP_LIMIT_BPS=500
AI_TRADING_FALLBACK_GAP_LIMIT_BPS=1000
AI_TRADING_PROVIDER_DECISION_SECS=300
AI_TRADING_FALLBACK_QUOTE_MAX_AGE_SEC=30
AI_TRADING_STRICT_GATING=1
AI_TRADING_MINUTE_ABORT_ON_GAPS=0
AI_TRADING_LIQ_FALLBACK_CAP=0.25

# ===== Minute-data tolerance (reduces false alarms when market is closed) =====
MINUTE_STALE_TOLERANCE_SEC=600
SKIP_MINUTE_CHECK_WHEN=market_closed

# ===== yfinance (backup) hygiene & batching =====
YF_TIMEOUT=8
YF_RETRIES=3
YF_BACKOFF=0.7
YF_CHUNK_SIZE=40
YF_CACHE_DIR=/var/cache/ai-trading-bot/yf

# ===== Screener throttles (less churn, fewer fetches) =====
SCREEN_BATCH_SIZE=25
SCREEN_TOPN=6
SCREEN_MIN_REFETCH_SEC=1800

# Execution fallbacks acceptable for Alpaca Basic/IEX
AI_TRADING_EXEC_ALLOW_FALLBACK_WITHOUT_NBBO=1
EXECUTION_ALLOW_FALLBACK_WITHOUT_NBBO=1
AI_TRADING_EXEC_ALLOW_FALLBACK_PRICE=1
AI_TRADING_EXEC_ALLOW_LAST_CLOSE=1
EXECUTION_ALLOW_LAST_CLOSE=1
EXECUTION_REQUIRE_BID_ASK=0
EXECUTION_REQUIRE_REALTIME_NBBO=0
EXECUTION_MARKET_ON_FALLBACK=0
EXECUTION_MAX_STALENESS_SEC=60

# Data gap tolerance
DATA_MAX_GAP_RATIO_BPS=500

# ============================================================
# ADDITIONS for Second Codex Prompt Appendices H-R
# (TCA, Replay, Walk-forward, Order Types, Portfolio Risk,
# Allocation, Liquidity Regime, Post-trade Learning, Quarantine,
# Decision Record Config Snapshots)
# ============================================================

# ===== APPENDIX H: TCA / EXECUTION QUALITY =====
AI_TRADING_TCA_ENABLED=1
AI_TRADING_TCA_PATH=runtime/tca_records.jsonl
AI_TRADING_EXECUTION_REPORT_ENABLED=1
AI_TRADING_EXECUTION_REPORT_DIR=runtime/execution_reports
AI_TRADING_EXECUTION_REPORT_FORMATS=json,csv
AI_TRADING_EXECUTION_REPORT_ROLLUP_TZ=America/New_York

# Benchmark definition for implementation shortfall
# arrival = decision (bar close / signal time) or submit (order submit time)
AI_TRADING_TCA_ARRIVAL_BENCHMARK=decision

# If NBBO not available, allow a proxy mid/spread model (must be explicit + logged)
AI_TRADING_TCA_ALLOW_PROXY_QUOTES=1
AI_TRADING_TCA_PROXY_SPREAD_BPS_DEFAULT=12
AI_TRADING_TCA_PROXY_MID_SOURCE=last_trade

# How long to wait for fills before writing a pending TCA record
AI_TRADING_TCA_PENDING_WRITE_SEC=60
AI_TRADING_TCA_UPDATE_ON_FILL=1

# ===== APPENDIX I: REPLAY HARNESS (LIVE PIPELINE REPLAY) =====
AI_TRADING_REPLAY_ENABLED=0
AI_TRADING_REPLAY_DATA_DIR=runtime/replay_data
AI_TRADING_REPLAY_OUTPUT_DIR=runtime/replay_outputs
AI_TRADING_REPLAY_SEED=42
AI_TRADING_REPLAY_RTH_ONLY=1
AI_TRADING_REPLAY_SPEEDUP=1
AI_TRADING_REPLAY_TIMEFRAMES=5Min,1Hour,1Day
AI_TRADING_REPLAY_SYMBOLS=
AI_TRADING_REPLAY_START_DATE=
AI_TRADING_REPLAY_END_DATE=

# Replay fill modeling
AI_TRADING_REPLAY_SIMULATE_FILLS=1
AI_TRADING_REPLAY_FILL_MODEL=next_bar_mid
AI_TRADING_REPLAY_FILL_SLIPPAGE_BPS=5
AI_TRADING_REPLAY_FILL_FEE_BPS=0

# If simulate fills, still enforce the full OMS gates (pretrade, dedupe, etc.)
AI_TRADING_REPLAY_ENFORCE_OMS_GATES=1

# ===== APPENDIX J: WALK-FORWARD + LEAKAGE GUARDS =====
AI_TRADING_WALK_FORWARD_ENABLED=0
AI_TRADING_WF_TRAIN_DAYS=180
AI_TRADING_WF_TEST_DAYS=30
AI_TRADING_WF_STEP_DAYS=30
AI_TRADING_WF_EMBARGO_DAYS=5
AI_TRADING_WF_COST_MODEL=from_tca
AI_TRADING_WF_FIXED_COST_BPS=15
AI_TRADING_WF_OUTPUT_DIR=runtime/walk_forward

# Hard fail CI if leakage checks fail
AI_TRADING_LEAKAGE_GUARDS_ENABLED=1
AI_TRADING_LEAKAGE_FAIL_HARD=1

# ===== APPENDIX K: ORDER TYPES / STRUCTURED EXITS =====
AI_TRADING_ORDER_TYPES_ENABLED=1

# Default order type policy (must match broker capabilities; fail-fast if invalid)
AI_TRADING_DEFAULT_ENTRY_ORDER_TYPE=limit
AI_TRADING_DEFAULT_EXIT_ORDER_TYPE=stop_limit
AI_TRADING_ALLOW_BRACKET_ORDERS=0
AI_TRADING_ALLOW_OCO_OTO=0

# Exit distances (sleeve-specific overrides can be added later)
AI_TRADING_STOP_LOSS_ATR_MULT=1.6
AI_TRADING_TAKE_PROFIT_ATR_MULT=2.4
AI_TRADING_TRAILING_STOP_ATR_MULT=1.2

# Guardrails for structured orders
AI_TRADING_EXIT_LEG_RECONCILE_REQUIRED=1
AI_TRADING_ORDER_TYPE_FAILFAST_ON_UNSUPPORTED=1

# ===== APPENDIX L: PORTFOLIO-LEVEL RISK TARGETING =====
AI_TRADING_PORTFOLIO_LIMITS_ENABLED=1
AI_TRADING_VOL_TARGETING_ENABLED=1
AI_TRADING_TARGET_ANNUAL_VOL=0.18
AI_TRADING_VOL_LOOKBACK_DAYS=20
AI_TRADING_VOL_MIN_SCALE=0.25
AI_TRADING_VOL_MAX_SCALE=1.25

# Concentration / correlation caps
AI_TRADING_CONCENTRATION_CAP_ENABLED=1
AI_TRADING_MAX_SYMBOL_WEIGHT=0.12
AI_TRADING_MAX_CLUSTER_WEIGHT=0.25
AI_TRADING_CORR_CAP_ENABLED=1
AI_TRADING_CORR_LOOKBACK_DAYS=30
AI_TRADING_CORR_THRESHOLD=0.80
AI_TRADING_CORR_GROUP_GROSS_CAP=0.35

# ===== APPENDIX N: SLEEVE CAPITAL ALLOCATION / AUM ROUTING =====
AI_TRADING_ALLOCATION_ENABLED=1
AI_TRADING_ALLOCATION_UPDATE_SCHEDULE=market_close
AI_TRADING_ALLOCATION_OUTPUT_PATH=runtime/allocation_state.json

# Allocation bounds + inertia
AI_TRADING_ALLOC_DAY_BASE_WEIGHT=0.40
AI_TRADING_ALLOC_SWING_BASE_WEIGHT=0.35
AI_TRADING_ALLOC_LONGSHORT_BASE_WEIGHT=0.25

AI_TRADING_ALLOC_MIN_WEIGHT=0.10
AI_TRADING_ALLOC_MAX_WEIGHT=0.60
AI_TRADING_ALLOC_DAILY_MAX_DELTA=0.05

# Performance inputs
AI_TRADING_ALLOC_USE_POSTCOST_EXPECTANCY=1
AI_TRADING_ALLOC_EXPECTANCY_WINDOW_TRADES=60
AI_TRADING_ALLOC_MIN_TRADES_FOR_ADJUST=15
AI_TRADING_ALLOC_DRAWDOWN_TRIGGER=0.06
AI_TRADING_ALLOC_EXPECTANCY_FLOOR_PCT=-0.0010

# ===== APPENDIX O: LIQUIDITY REGIME / MARKET IMPACT =====
AI_TRADING_LIQ_REGIME_ENABLED=1
AI_TRADING_LIQ_LOOKBACK_BARS=60

# Participation cap: block/scale if order > X% of rolling volume
AI_TRADING_PARTICIPATION_CAP_ENABLED=1
AI_TRADING_MAX_PARTICIPATION_PCT=0.015
AI_TRADING_PARTICIPATION_BLOCK_MODE=block
AI_TRADING_PARTICIPATION_SCALE_MIN=0.25

# Regime thresholds (simple defaults)
AI_TRADING_LIQ_THIN_SPREAD_BPS=25
AI_TRADING_LIQ_THIN_VOL_MULT=1.8
AI_TRADING_LIQ_THIN_MAX_ORDER_DOLLARS=5000

# Liquidity regime impacts on costs/collars
AI_TRADING_LIQ_THIN_COST_MULT=1.3
AI_TRADING_LIQ_THIN_COLLAR_MULT=0.8

# ===== APPENDIX P: POST-TRADE LEARNING (BOUNDED ADAPTATION) =====
AI_TRADING_POST_TRADE_LEARNING_ENABLED=1
AI_TRADING_LEARNING_OUTPUT_PATH=runtime/learned_overrides.json
AI_TRADING_LEARNING_APPLY_OVERRIDES=1
AI_TRADING_LEARNING_RUN_SCHEDULE=market_close

# Safety bounds on parameter drift
AI_TRADING_LEARNING_MAX_DAILY_DELTA_BPS=3
AI_TRADING_LEARNING_MAX_DAILY_DELTA_FRAC=0.05
AI_TRADING_LEARNING_MAX_OVERRIDE_AGE_DAYS=30

# Learning triggers
AI_TRADING_LEARNING_IS_BPS_TRIGGER=18
AI_TRADING_LEARNING_FLIP_RATE_TRIGGER=0.25
AI_TRADING_LEARNING_TURNOVER_TRIGGER_DOLLARS=100000

# What learning is allowed to adjust
AI_TRADING_LEARNING_ADJUST_COST_BUFFER=1
AI_TRADING_LEARNING_ADJUST_DEADBANDS=1
AI_TRADING_LEARNING_ADJUST_CONFIRM_SIGNALS=1
AI_TRADING_LEARNING_ADJUST_TURNOVER_CAPS=0

# ===== APPENDIX Q: QUARANTINE (AUTO-DISABLE MISBEHAVING SLEEVES) =====
AI_TRADING_QUARANTINE_ENABLED=1
AI_TRADING_QUARANTINE_STATE_PATH=runtime/quarantine_state.json

# Quarantine durations
AI_TRADING_QUARANTINE_DURATION_BARS_DAY=6
AI_TRADING_QUARANTINE_DURATION_BARS_SWING=3
AI_TRADING_QUARANTINE_DURATION_DAYS_LONGSHORT=2

# Quarantine triggers
AI_TRADING_QUARANTINE_BREAKER_OPEN_COUNT=2
AI_TRADING_QUARANTINE_REJECT_RATE_TRIGGER=0.15
AI_TRADING_QUARANTINE_COST_GATE_BLOCK_RATE_TRIGGER=0.60
AI_TRADING_QUARANTINE_EXPECTANCY_FLOOR_PCT=-0.0015
AI_TRADING_QUARANTINE_MIN_TRADES=12

# Behavior when quarantined
AI_TRADING_QUARANTINE_MODE=block
AI_TRADING_QUARANTINE_APPLIES_TO=sleeve,symbol

# ===== APPENDIX R: DECISION RECORD CONFIG SNAPSHOTS =====
AI_TRADING_DECISION_RECORD_SNAPSHOT_ENABLED=1
AI_TRADING_DECISION_RECORD_SNAPSHOT_REDACT_SECRETS=1
AI_TRADING_DECISION_RECORD_SNAPSHOT_INCLUDE_LIMITS=1
AI_TRADING_DECISION_RECORD_SNAPSHOT_INCLUDE_ALLOCATION=1
AI_TRADING_DECISION_RECORD_SNAPSHOT_INCLUDE_LIQ_REGIME=1
AI_TRADING_DECISION_RECORD_SNAPSHOT_INCLUDE_LEARNED_OVERRIDES=1

# Optional: write separate snapshot stream (in addition to decision records)
AI_TRADING_CONFIG_SNAPSHOT_PATH=runtime/config_snapshots.jsonl

# ===== EXTRA: PROFIT-SAFETY DEFAULTS THAT PAIR WELL WITH H-R =====
AI_TRADING_BLOCK_TRADING_IF_TCA_STALE=0
AI_TRADING_MIN_TCA_SAMPLES_FOR_ADAPT=20
AI_TRADING_REQUIRE_TCA_FOR_ALLOCATION=0
